<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBuildingKG V25: –ú–æ–¥—É–ª—å –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ê—É–¥–∏—Ç–∞</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS (–ö–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Inter Font (–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à—Ä–∏—Ñ—Ç) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- –°–¢–†–û–ì–ò–ô –ù–ê–£–ß–ù–´–ô –î–ò–ó–ê–ô–ù V25 --- */
        
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ (–¢–µ–º–Ω—ã–π, –≤—ã—Å–æ–∫–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ñ–æ–Ω) */
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #182029; /* –ì–ª—É–±–æ–∫–∏–π –ß–∞—Ä–æ–∞–ª—å–Ω—ã–π Navy */
            color: #E0E6EB; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
        }
        
        /* –•–µ–¥–µ—Ä (–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –±—Ä–µ–Ω–¥–∏–Ω–≥) */
        header { 
            background-color: #2C3E50; /* –¢–µ–º–Ω—ã–π –°–ª–∞–Ω–µ—Ü */
            color: #E0E6EB; 
            padding: 20px 30px; 
            border-bottom: 5px solid #00BFFF; /* –Ø—Ä–∫–∏–π –¶–∏–∞–Ω–æ–≤—ã–π –ê–∫—Ü–µ–Ω—Ç */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        header h1 { 
            font-size: 1.8rem; 
            margin: 0; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            color: #00BFFF; /* –¶–∏–∞–Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        }
        header p { margin: 5px 0 0 0; font-weight: 300; opacity: 0.7; font-size: 0.9rem;}

        /* –ö–∞—Ä—Ç–∞ */
        #map { 
            height: 65vh; 
            width: 100%; 
            border: 1px solid #00BFFF; /* –†–∞–º–∫–∞ –∞–∫—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ */
            cursor: default;
        }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ö–æ–Ω—Å–æ–ª—å) */
        #controls { 
            padding: 30px; 
            background: #1F2A38; /* –°–ª–µ–≥–∫–∞ —Å–≤–µ—Ç–ª–µ–µ —Ñ–æ–Ω–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3); 
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ */
        h2 { 
            color: #00BFFF; 
            border-bottom: 2px solid #37475A; 
            padding-bottom: 10px; 
            margin-top: 0; 
            font-weight: 600;
        }
        
        /* –ì—Ä—É–ø–ø–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-group { 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap; 
            padding: 15px;
            border: 1px solid #37475A;
            border-radius: 6px;
            background-color: #2C3E50;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button { 
            background-color: #00BFFF; /* –¶–∏–∞–Ω–æ–≤—ã–π */
            color: #182029; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —è—Ä–∫–æ–π –∫–Ω–æ–ø–∫–µ */
            border: none; 
            padding: 10px 20px; 
            font-size: 15px; 
            cursor: pointer; 
            border-radius: 6px; 
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        button:hover { background-color: #0099CC; transform: translateY(-1px); }
        #clear-button { 
            background-color: #FF5733; /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
            color: white; 
        } 
        #clear-button:hover { background-color: #CC4428; }
        
        /* –ü–æ–ª—è –≤–≤–æ–¥–∞/–≤—ã–±–æ—Ä–∞ */
        .search-group input, select { 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #37475A; 
            background-color: #1F2A38; 
            color: #E0E6EB;
            flex-grow: 1; 
            min-width: 200px; 
            font-size: 15px;
        }
        .search-group button { 
            background-color: #4CAF50; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–æ–∏—Å–∫–∞/–∑–∞–ø—É—Å–∫–∞ */
            color: #182029;
        } 
        .search-group button:hover { background-color: #43A047; }
        
        /* –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–û—Ç—á–µ—Ç) */
        #results { margin-top: 25px; }
        .result-card { 
            border: 2px solid #00BFFF; 
            padding: 20px; 
            margin-bottom: 25px; 
            border-radius: 10px; 
            background-color: #1F2A38;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.2);
        }
        .result-card h4 { color: #00BFFF; margin-top: 0; border-bottom: 1px solid #37475A; padding-bottom: 10px; }

        /* –û—Ü–µ–Ω–∫–∞ –∏ –í–µ—Ä–¥–∏–∫—Ç */
        .score-box { 
            font-size: 2.5em; 
            font-weight: 700; 
            display: inline-block; 
            padding: 10px 15px; 
            border-radius: 8px; 
            color: #182029; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ü–≤–µ—Ç–Ω–æ–º —Ñ–æ–Ω–µ */
            min-width: 100px;
            text-align: center;
            margin-right: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            vertical-align: middle;
        }
        .report-section { 
            border: 1px solid #37475A; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 6px; 
            background-color: #2C3E50;
        }
        .report-section h4 { color: #4CAF50; margin: 0 0 10px 0; border-bottom: 1px solid #37475A; padding-bottom: 5px; font-size: 1.1em; }
        .report-factors li { margin-bottom: 5px; color: #B3C1CC; font-size: 0.9em; }

        /* –ò—Ç–æ–≥–æ–≤—ã–π –í–µ—Ä–¥–∏–∫—Ç */
        .verdict {
            padding: 18px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            border-radius: 10px;
            margin-top: 20px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid currentColor; /* –†–∞–º–∫–∞ —Ç–æ–≥–æ –∂–µ —Ü–≤–µ—Ç–∞, —á—Ç–æ –∏ —Ñ–æ–Ω */
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –±–ª–æ–∫–∞ —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏ */
        .geo-data-grid {
            margin-top: 20px;
            padding: 15px;
            background-color: #182029; /* –°–∞–º—ã–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0, 191, 255, 0.1);
        }
        .geo-item {
            padding: 10px;
            border-radius: 4px;
            background-color: #2C3E50; /* –¢–µ–º–Ω—ã–π —Å–ª–∞–Ω–µ—Ü */
            margin-bottom: 10px;
        }
        .geo-item p { margin: 0; font-size: 0.85em; }
        .geo-item strong { color: #00BFFF; font-size: 1.1em; }


        /* –°—Ç–∏–ª—å –¥–ª—è –∫—É—Ä—Å–æ—Ä–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .drawing-cursor {
            cursor: crosshair !important;
        }

        /* –°–µ–∫—Ü–∏—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ */
        #data-methodology {
            padding: 20px 30px;
            background-color: #2C3E50;
            border-top: 3px solid #00BFFF;
            color: #B3C1CC;
            font-size: 0.9em;
        }
        #data-methodology strong { color: #00BFFF; }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 768px) {
            #controls { padding: 15px; }
            .control-group { flex-direction: column; align-items: stretch; gap: 10px; }
            .search-group input { min-width: auto; }
            button { width: 100%; }
            #map { height: 50vh; }
            .geo-data-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <span style="font-size: 2.5rem; margin-right: 15px;">üî¨</span>
            SmartBuildingKG V25: –ú–æ–¥—É–ª—å –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ê—É–¥–∏—Ç–∞
        </h1>
        <p>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Å–∏—Å—Ç–µ–º–µ $R$-—Ñ–∞–∫—Ç–æ—Ä–æ–≤. –°–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –¥–ª—è –ö–†. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å Copernicus/WorldPop</p>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <div id="map"></div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="controls">
        <h2>–ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ö–æ–Ω—Å–æ–ª—å –∏ –†–µ–≥–ª–∞–º–µ–Ω—Ç –û—Ü–µ–Ω–∫–∏ $\tau(\phi)$</h2>
        
        <!-- –ì—Ä—É–ø–ø–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —É–ª–∏—Ü–∞–º -->
        <div class="control-group search-group">
            <label for="street_search" style="font-weight: 600; color: #00BFFF;">üîé –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã $\zeta$:</label>
            <input type="text" id="street_search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞: –ß—É–π, –ú–∞–Ω–∞—Å–∞, –ò—Å—Å—ã–∫-–ö—É–ª—å..." >
            <button onclick="handleStreetSearch()">
                –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å $\text{A}(\zeta)$
            </button>
            <div id="search_feedback" style="margin-top: 5px; color: #4CAF50; width: 100%; font-weight: 600;">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ó–æ–Ω–∞–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏–∑.</div>
        </div>

        <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞ (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–æ—Ç–∞—Ü–∏–∏) -->
        <div class="control-group">
            <label for="building_type" style="margin-right: 15px; font-weight: 600; color: #E0E6EB;">üèó –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ü—Ä–æ–µ–∫—Ç–∞:</label>
            <select id="building_type">
                <option value="residential_block">–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å (–ë–∞–∑–æ–≤—ã–π –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç $R_1$)</option>
                <option value="hospital">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç $R_4$)</option>
                <option value="school">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ (–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç $R_3$)</option>
                <option value="industrial">–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç (–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç $R_2$)</option>
                <option value="wind_farm">–í–µ—Ç—Ä—è–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è (–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç $R_5$)</option>
            </select>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
        <div class="control-group" style="background-color: #1F2A38;">
            <button onclick="activatePolygonMode()" style="background-color: #00BFFF;">
                <span style="font-size: 1.2em; margin-right: 5px;">&#x29C4;</span> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ú–æ–¥—É–ª—å –ó–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ê–Ω–∞–ª–∏–∑–∞ (–ö–ª–∏–∫-–ö–ª–∏–∫-Double Click)
            </button>
            <button id="clear-button" onclick="clearAllMarkers()">
                <span style="font-size: 1.2em; margin-right: 5px;">&#x2716;</span> –°–±—Ä–æ—Å –∏ –û—á–∏—Å—Ç–∫–∞ –°–ª–æ—è –ê—É–¥–∏—Ç–∞
            </button>
        </div>

        <div id="results">
            <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª –æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ –¥–∞–Ω–Ω—ã—Ö -->
    <div id="data-methodology">
        <h4>$R$-–ú–µ—Ç—Ä–∏–∫–∞: –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏ –ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö</h4>
        <p>
            –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ SmartBuildingKG –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <strong>—á–µ—Ç—ã—Ä–µ –∫–ª—é—á–µ–≤—ã—Ö –≤–µ–∫—Ç–æ—Ä–∞ –æ—Ü–µ–Ω–∫–∏</strong>, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ–µ—Ç –≤–µ—Å–æ–≤–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: 
            <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (40%)</strong>, –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (25%), –ó–¥–æ—Ä–æ–≤—å–µ –∏ –ö–ª–∏–º–∞—Ç (20%), –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (15%). 
            –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Copernicus/WorldPop/WRI –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–º–∞—Ç–∞, –ø–æ—á–≤—ã –∏ —ç–∫–æ–ª–æ–≥–∏–∏. –í—Å–µ –æ—Ç—á–µ—Ç—ã —Å–ª–µ–¥—É—é—Ç –°—Ç—Ä–æ–≥–æ–º—É –†–µ–≥–ª–∞–º–µ–Ω—Ç—É –û—Ü–µ–Ω–∫–∏ –†–∏—Å–∫–æ–≤.
        </p>
    </div>

    <!-- 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- 4. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ -->
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã, —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ë–∏—à–∫–µ–∫–µ
        var map = L.map('map').setView([42.8744, 74.5980], 12); 
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ —Å–ª–æ—è OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors | SmartBuildingKG V25',
            maxZoom: 18
        }).addTo(map);

        var markers = L.layerGroup().addTo(map); 
        var polygonMarkers = L.layerGroup().addTo(map); 
        var drawnPolygons = L.layerGroup().addTo(map); 
        
        var markerCount = 0;
        
        var isDrawingPolygon = false;
        var polygonPoints = []; 
        var currentPolyline = null;
        
        // --- V25: –ë–ê–ó–ê –ö–û–û–†–î–ò–ù–ê–¢ ---
        const STREET_COORDINATES = {
            "—á—É–π": { lat: 42.875, lng: 74.60, name: "–ü—Ä–æ—Å–ø–µ–∫—Ç –ß—É–π (–¶–µ–Ω—Ç—Ä –ë–∏—à–∫–µ–∫–∞)" },
            "–º–∞–Ω–∞—Å–∞": { lat: 42.878, lng: 74.575, name: "–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∞–Ω–∞—Å–∞" },
            "–æ—à": { lat: 40.510, lng: 72.800, name: "–¶–µ–Ω—Ç—Ä –û—à–∞" },
            "–∫–∞—Ä–∞–∫–æ–ª": { lat: 42.483, lng: 78.393, name: "–¶–µ–Ω—Ç—Ä –ö–∞—Ä–∞–∫–æ–ª–∞ (–û–∑–µ—Ä–æ)" },
            "–∏—Å—Å—ã–∫-–∫—É–ª—å": { lat: 42.36, lng: 77.30, name: "–û–∑–µ—Ä–æ –ò—Å—Å—ã–∫-–ö—É–ª—å (–í–æ–¥–∞/–ö—Ä–∏—Ç–∏–∫–∞)" },
            "–ø–∏–∫ –ø–æ–±–µ–¥—ã": { lat: 42.03, lng: 80.12, name: "–ü–∏–∫ –ü–æ–±–µ–¥—ã (–ì–æ—Ä—ã/–ö—Ä–∏—Ç–∏–∫–∞)" }
        };

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ —Ü–≤–µ—Ç–∞ –æ—Ü–µ–Ω–∫–∏ ---
        function getColorForScore(score) {
            if (score >= 90) return '#4CAF50'; // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ (–ó–µ–ª–µ–Ω—ã–π)
            if (score >= 75) return '#FFC107'; // –ü—Ä–∏–µ–º–ª–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–ñ–µ–ª—Ç—ã–π)
            if (score >= 50) return '#FF9800'; // –ù–µ—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (–û—Ä–∞–Ω–∂–µ–≤—ã–π)
            return '#F44336'; // –ó–∞–ø—Ä–µ—â–µ–Ω–æ (–ö—Ä–∞—Å–Ω—ã–π)
        }
        
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ú–æ–¥—É–ª—å –°–∏–º—É–ª—è—Ü–∏–∏ –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ü—Ä–æ—Ñ–∏–ª—è (Copernicus/WRI/WorldPop) ---
        function getEnvironmentalProfile(lat, lng) {
            // A. –ì–æ—Ä–Ω—ã–µ/–í–æ–¥–Ω—ã–µ –ó–æ–Ω—ã (–ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, –ß–∏—Å—Ç—ã–π –≤–æ–∑–¥—É—Ö)
            if (lng > 75.5 || lat < 41.5 || (lat > 42.0 && lat < 43.0 && lng > 76.5 && lng < 78.5)) {
                 return {
                    soil: { type: "–ì–æ—Ä–Ω—ã–µ/–ì–∏–¥—Ä–æ–º–æ—Ä—Ñ–Ω—ã–µ", suitability: "–ù–∏–∑–∫–∞—è" },
                    climate: { avgTemp: "+5 ¬∞C", humidity: "70%" },
                    environment: { airQuality: "–í—ã—Å–æ–∫–∞—è (PM2.5: < 10 ¬µg/m¬≥)", pollutionSource: "–ù–µ—Ç. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.", greenZones: "–õ–µ—Å–∞, –∞–ª—å–ø–∏–π—Å–∫–∏–µ –ª—É–≥–∞." },
                    healthRisk: { riskLevel: "–ù–∏–∑–∫–∏–π. (–•–æ–ª–æ–¥–æ–≤–æ–π —Å—Ç—Ä–µ—Å—Å)." }
                };
            }
            
            // B. –î–æ–ª–∏–Ω—ã (–ë–∏—à–∫–µ–∫, –û—à - –í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ)
            return {
                soil: { type: "–ì–æ—Ä–Ω–æ-–¥–æ–ª–∏–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–∑—ë–º—ã", suitability: "–í—ã—Å–æ–∫–∞—è" },
                climate: { avgTemp: "+12.2 ¬∞C", humidity: "60%" },
                environment: { 
                    airQuality: "–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–∞—è (PM2.5: ~44 ¬µg/m¬≥)", // –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö WRI
                    pollutionSource: "–£–≥–æ–ª—å–Ω–æ–µ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç. –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–º–∏ –∏–Ω–≤–µ—Ä—Å–∏—è–º–∏.", 
                    greenZones: "–†–∞–∑–≤–∏—Ç–∞—è —Å–µ—Ç—å –ø–∞—Ä–∫–æ–≤ –∏ –±—É–ª—å–≤–∞—Ä–æ–≤." 
                },
                healthRisk: { riskLevel: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π. (–†–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∏ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è)." }
            };
        }

        // --- V25: –§—É–Ω–∫—Ü–∏—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –î–∞–Ω–Ω—ã–º (–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è) ---
        async function fetchGeospatialData(lat, lng) {
            await new Promise(resolve => setTimeout(resolve, 50)); 
            
            let landCoverCategory = 'LAND_SIMULATED'; 
            let altitude, maxSlope, seismicRisk, naturalDisasterRisk, windSpeed, roadProximity, populationDensity;
            let isUrbanPlateau = false; 
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (Copernicus, WRI, WorldPop sim)
            const envProfile = getEnvironmentalProfile(lat, lng);

            // --- 1. –°–ò–ú–£–õ–Ø–¶–ò–Ø –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–• –ó–û–ù (–¢–û–ü–û–ì–†–ê–§–ò–Ø) ---
            if (lat > 42.0 && lat < 43.0 && lng > 76.5 && lng < 78.5) { // –ò—Å—Å—ã–∫-–ö—É–ª—å
                landCoverCategory = 'WATER_LAKE';
            } 
            else if (lng > 75.5 || lat < 41.5) { // –í—ã—Å–æ–∫–∏–µ –ì–æ—Ä—ã/–ì–æ—Ä–Ω—ã–µ –•—Ä–µ–±—Ç—ã
                altitude = 2500 + Math.random() * 1500; 
                maxSlope = 15 + Math.random() * 25; 
                seismicRisk = (Math.random() < 0.8) ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π' : '–í—ã—Å–æ–∫–∏–π'; 
                naturalDisasterRisk = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–û–ø–æ–ª–∑–Ω–∏/–õ–∞–≤–∏–Ω—ã)';
                windSpeed = 10 + Math.random() * 15; 
                roadProximity = (Math.random() < 0.2) ? '–ü–ª–æ—Ö–æ (–±–æ–ª–µ–µ 10 –∫–º)' : '–û—á–µ–Ω—å –ü–ª–æ—Ö–æ (>20 –∫–º)';
                populationDensity = 10 + Math.random() * 100; 
                if (altitude > 3500) landCoverCategory = 'MOUNTAIN_PEAK'; 
            }
            else { // –î–æ–ª–∏–Ω—ã –∏ –ü–ª–∞—Ç–æ (–ë–∏—à–∫–µ–∫ / –ß—É–π—Å–∫–∞—è –¥–æ–ª–∏–Ω–∞)
                altitude = 700 + Math.random() * 500; 
                maxSlope = 0.5 + Math.random() * 2; 
                seismicRisk = (Math.random() < 0.6) ? '–í—ã—Å–æ–∫–∏–π' : '–°—Ä–µ–¥–Ω–∏–π'; 
                naturalDisasterRisk = '–°—Ä–µ–¥–Ω–∏–π (–ü–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è)';
                windSpeed = 3 + Math.random() * 8; 
                roadProximity = (Math.random() < 0.9) ? '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)' : '–•–æ—Ä–æ—à–æ (2-5 –∫–º)';
                populationDensity = 500 + Math.random() * 1000; 
                if (maxSlope < 3 && populationDensity > 500) isUrbanPlateau = true;
            }

            // --- 2. –û–ë–©–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô ---
            if (landCoverCategory === 'WATER_LAKE' || landCoverCategory === 'MOUNTAIN_PEAK') {
                altitude = (landCoverCategory === 'WATER_LAKE') ? 1600 : 3800; 
                maxSlope = 0;
                seismicRisk = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π';
                naturalDisasterRisk = (landCoverCategory === 'WATER_LAKE') ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–ù–∞–≤–æ–¥–Ω–µ–Ω–∏—è)' : '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–õ–∞–≤–∏–Ω—ã)';
                roadProximity = '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ';
                windSpeed = (landCoverCategory === 'WATER_LAKE') ? 20 : 0; 
                populationDensity = 0;
            }
            
            const flatnessPercentage = (100 - parseFloat(maxSlope) * 1.5).toFixed(0); 

            return {
                // –¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—è –∏ –ë–∞–∑–∞ (V25 Original)
                landCoverType: '–°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä—É–Ω—Ç',
                maxSlope: parseFloat(maxSlope.toFixed(1)), 
                flatnessPercentage: parseFloat(flatnessPercentage),
                naturalDisasterRisk: naturalDisasterRisk,
                seismicRisk: seismicRisk,
                populationDensity: parseFloat(populationDensity.toFixed(0)),
                roadProximity: roadProximity,
                windSpeed: parseFloat(windSpeed.toFixed(1)),
                altitude: parseFloat(altitude.toFixed(0)), 
                landCoverCategory: landCoverCategory, 
                lat: lat,
                lng: lng,
                isUrbanPlateau: isUrbanPlateau,
                // –ù–û–í–´–ï –î–ê–ù–ù–´–ï (Copernicus/WorldPop/WRI)
                envProfile: envProfile
            };
        }

        // --- V25: –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ê–£–î–ò–¢) - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è ---
        function getAnalysisScore(data, buildingType) {
            let safetyPenalty = 0;
            let sustainabilityPenalty = 0; 
            let healthPenalty = 0;
            let efficiencyBonus = 0;
            
            let baselinePenalty = 10; 
            safetyPenalty += baselinePenalty;

            let report = {
                safety: { score: 100, factors: [] },
                sustainability: { score: 100, factors: [] },
                healthClimate: { score: 100, factors: [] }, 
                efficiency: { score: 100, factors: [] },
            };
            
            // --- 1. –ü–†–û–í–ï–†–ö–ò –ê–ë–°–û–õ–Æ–¢–ù–û–ì–û –ó–ê–ü–†–ï–¢–ê (HARD STOPS) ---
            let reason = '';
            if (data.landCoverCategory.includes('WATER_') || data.roadProximity === '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ') { 
                reason = (data.landCoverCategory.includes('WATER_')) ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–æ–Ω–∞: –í–æ–¥–æ–µ–º/–û–∑–µ—Ä–æ' : '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞';
            }
            if (data.landCoverCategory === 'MOUNTAIN_PEAK' || data.altitude > 3500) {
                 reason = (data.landCoverCategory === 'MOUNTAIN_PEAK') ? '–ì–æ—Ä–Ω—ã–π –ø–∏–∫/–õ–µ–¥–Ω–∏–∫ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)' : –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã ($>3500 \\text{ –º}$);
            }
            
            if (reason) {
                report.safety.factors.push(*–ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢:* ${reason}. –ù–∞—Ä—É—à–µ–Ω–∏–µ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞.);
                return {
                    finalScore: 0,
                    report, 
                    finalVerdict: { text: '–ê–£–î–ò–¢: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó', color: '#F44336', sub: –ü—Ä–∏—á–∏–Ω–∞: ${reason} },
                    safetyScore: 0
                };
            }

            let hardStopWarning = false; 
            if (data.isUrbanPlateau) {
                const safetyBoost = 25;
                safetyPenalty -= safetyBoost;
                report.safety.factors.push(*–ò–ù–ñ–ï–ù–ï–†–ù–´–ô –ë–û–ù–£–°:* –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –≥–æ—Ä–æ–¥—Å–∫–æ–µ –ø–ª–∞—Ç–æ. ($+25$ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏));
            }

            // --- 2. –í–ï–ö–¢–û–† –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (SAFETY & DISASTER RISK) - –í–ï–° 40% ---
            
            if (data.seismicRisk === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π') { safetyPenalty += 70; report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ ($9+\\text{ –±–∞–ª–ª–æ–≤}$). ($-70$)'); } 
            else if (data.seismicRisk === '–í—ã—Å–æ–∫–∏–π') { safetyPenalty += 40; report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ ($7-8 \\text{ –±–∞–ª–ª–æ–≤}$). ($-40$)'); } 
            
            if (data.maxSlope > 20) { 
                 safetyPenalty += 60;
                 report.safety.factors.push(*–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö:* –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π —É–∫–ª–æ–Ω ($>20^\circ$). –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ–ø–æ–ª–∑–Ω–µ–π. ($-60$));
                 hardStopWarning = true; 
            } else if (data.maxSlope > 10) {
                 safetyPenalty += 25; 
                 report.safety.factors.push(–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫: –ö—Ä—É—Ç–æ–π —Å–∫–ª–æ–Ω (${data.maxSlope}^\circ$). –¢—Ä–µ–±—É–µ—Ç—Å—è —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ. ($-25$));
            }

            if (data.naturalDisasterRisk.includes('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π')) { safetyPenalty += 20; report.safety.factors.push(–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ ${data.naturalDisasterRisk} ($-20$)); }
            
            // --- 3. –í–ï–ö–¢–û–† –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò (SUSTAINABILITY & DEMOGRAPHY) - –í–ï–° 25% ---
            
            if (data.populationDensity > 1200) { sustainabilityPenalty += 50; report.sustainability.factors.push(–î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å (WorldPop sim): –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å. ($-50$)); } 
            else if (data.populationDensity < 100) { sustainabilityPenalty += 10; report.sustainability.factors.push(–ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (WorldPop sim): –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. ($-10$)); }
            
            if (data.envProfile.environment.airQuality.includes("–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–∞—è")) { sustainabilityPenalty += 30; report.sustainability.factors.push(–≠–∫–æ-–°—Ç—Ä–µ—Å—Å (WRI sim): –°–∏–ª—å–Ω–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞. ($-30$)); }
            
            // --- 4. –í–ï–ö–¢–û–† –ó–î–û–†–û–í–¨–Ø –ò –ö–õ–ò–ú–ê–¢–ê (HEALTH & MICROCLIMATE) - –í–ï–° 20% ---
            
            // –ù–û–í–´–ô –§–ê–ö–¢–û–†: –ö–∞—á–µ—Å—Ç–≤–æ –í–æ–∑–¥—É—Ö–∞
            if (data.envProfile.environment.airQuality.includes("–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–∞—è")) {
                healthPenalty += 60; 
                report.healthClimate.factors.push(*–≠–ö–û-–ö–†–ò–ó–ò–°:* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞ PM2.5. (–°–∏–º—É–ª—è—Ü–∏—è WRI/Copernicus). ($-60$));
            } else if (data.envProfile.environment.airQuality.includes("–ù–∏–∑–∫–∞—è")) {
                healthPenalty += 30; 
                report.healthClimate.factors.push(*–≠–ö–û-–†–ò–°–ö:* –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞. ($-30$));
            }

            // –ù–û–í–´–ô –§–ê–ö–¢–û–†: –£—Ä–æ–≤–µ–Ω—å –†–∏—Å–∫–∞ –ó–¥–æ—Ä–æ–≤—å—è
            if (data.envProfile.healthRisk.riskLevel === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π') { healthPenalty += 30; report.healthClimate.factors.push(–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫: –í—ã—Å–æ–∫–∞—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –ø–∞—Ç–æ–≥–µ–Ω–æ–≤. ($-30$)); }
            
            // --- 5. –í–ï–ö–¢–û–† –í–´–ì–û–î–ù–û–°–¢–ò/–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò (EFFICIENCY) - –í–ï–° 15% ---

            if (data.roadProximity.includes('–û—á–µ–Ω—å –ü–ª–æ—Ö–æ')) {
                efficiencyBonus -= 80; 
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –ß—Ä–µ–∑–º–µ—Ä–Ω–∞—è —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å ($>20 \\text{ –∫–º}$). –ù–µ—Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å. ($-80$)');
            } else if (data.roadProximity.includes('–ü–ª–æ—Ö–æ')) {
                efficiencyBonus -= 40; 
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –£–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å ($>10 \\text{ –∫–º}$). ($-40$)');
            } else if (data.roadProximity === '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)') {
                efficiencyBonus += 15; 
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –ò–¥–µ–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å. ($+15$)');
            }
            
            // –ù–û–í–´–ô –§–ê–ö–¢–û–†: –ü—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å –ü–æ—á–≤—ã (–¥–ª—è —Å/—Ö, –æ–∑–µ–ª–µ–Ω–µ–Ω–∏—è)
            if (buildingType !== 'industrial' && buildingType !== 'wind_farm') {
                if (data.envProfile.soil.suitability === '–í—ã—Å–æ–∫–∞—è') {
                    efficiencyBonus += 10;
                    report.efficiency.factors.push(–ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Ä–µ—Å—É—Ä—Å (Copernicus sim): –í—ã—Å–æ–∫–∞—è –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã –¥–ª—è –æ–∑–µ–ª–µ–Ω–µ–Ω–∏—è/—Å/—Ö. ($+10$));
                }
            } else if (buildingType === 'wind_farm') {
                if (data.windSpeed > 15) { efficiencyBonus += 35; report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. ($+35$)'); } 
                else if (data.windSpeed < 7) { efficiencyBonus -= 50; report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –ù–∏–∑–∫–∏–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. ($-50$)'); }
            } else if (data.windSpeed > 15 && buildingType !== 'wind_farm') {
                 safetyPenalty += 15;
                 report.safety.factors.push('–°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ä–∏—Å–∫. ($-15$)');
            }

            // –§–∏–∫—Å–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ 0 –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ 100 –±–∞–ª–ª–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
            const safetyScore = Math.max(0, 100 - safetyPenalty);
            report.safety.score = safetyScore.toFixed(0);
            report.sustainability.score = Math.max(0, 100 - sustainabilityPenalty).toFixed(0);
            report.healthClimate.score = Math.max(0, 100 - healthPenalty).toFixed(0);
            report.efficiency.score = Math.max(0, 100 + efficiencyBonus).toFixed(0);
            
            // –†–∞—Å—á–µ—Ç –§–∏–Ω–∞–ª—å–Ω–æ–≥–æ –û—Ü–µ–Ω–æ—á–Ω–æ–≥–æ –ë–∞
            const finalScore = (
                0.40 * report.safety.score + 
                0.25 * report.sustainability.score + 
                0.20 * report.healthClimate.score +
                0.15 * report.efficiency.score 
            ).toFixed(0);

            // --- –§–ò–ù–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢–ò–í–ù–´–ô –í–ï–†–î–ò–ö–¢ ---
            let finalVerdict = { text: '–ê–£–î–ò–¢ –ü–†–û–ô–î–ï–ù: –í–´–°–û–ö–ò–ô –ü–û–¢–ï–ù–¶–ò–ê–õ', color: '#4CAF50', sub: '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é. –†–∏—Å–∫–∏ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.' }; 
            
            if (hardStopWarning || safetyScore < 20 || finalScore < 45) { 
                finalVerdict = { text: '–ê–£–î–ò–¢: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó', color: '#F44336', sub: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º—ã–µ —Ä–∏—Å–∫–∏. –ù–∞—Ä—É—à–µ–Ω–∏–µ –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.' };
            } else if (finalScore < 70) { 
                 finalVerdict = { text: '–ê–£–î–ò–¢: –ù–ò–ó–ö–ê–Ø –†–ï–ù–¢–ê–ë–ï–õ–¨–ù–û–°–¢–¨', color: '#FF9800', sub: '–ü—Ä–æ–µ–∫—Ç —Å–ª–æ–∂–µ–Ω –∏ —Ç—Ä–µ–±—É–µ—Ç –≤—ã—Å–æ–∫–∏—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –≤ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é —Ä–∏—Å–∫–æ–≤.' };
            } else if (finalScore < 85) { 
                finalVerdict = { text: '–ê–£–î–ò–¢: –ü–†–ò–ï–ú–õ–ï–ú–´–ô (–¢–†–ï–ë–£–ï–¢–°–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø)', color: '#FFC107', sub: '–£–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏. –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç.' };
            }

            return { finalScore: parseInt(finalScore), report, finalVerdict, safetyScore: safetyScore };
        }
        
        // --- V25: –§—É–Ω–∫—Ü–∏—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ---
        async function simulateMarkerAnalysis(lat, lng, buildingType, locationName) {
            markerCount++;
            const markerId = point_marker_${markerCount};
            const buildingNameText = document.getElementById('building_type').options[document.getElementById('building_type').selectedIndex].text;
            const resultsDiv = document.getElementById('results');

            // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
            const newReportHtml = `<div id="${markerId}" class="result-card">
                <h4>–û—Ç—á–µ—Ç #${markerCount}: –¢–æ—á–µ—á–Ω—ã–π –ê—É–¥–∏—Ç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã $\zeta$ - ${locationName}</h4>
                <p><strong>–ò–¥–µ—Ç $\text{A}(\zeta)$:</strong> <span class="score-box" style="background-color: gray;">...</span></p>
            </div>`;
            resultsDiv.innerHTML = newReportHtml + resultsDiv.innerHTML;
            const currentReportDiv = document.getElementById(markerId);

            currentReportDiv.innerHTML += <p style="font-style: italic; color: #B3C1CC;">–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ —Å–∏–º—É–ª—è—Ç–æ—Ä—É $R$-—Ñ–∞–∫—Ç–æ—Ä–æ–≤ (V25 Enhanced)...</p>;

            // –ù–û–í–´–ô –í–´–ó–û–í –§–£–ù–ö–¶–ò–ò
            const rawData = await fetchGeospatialData(lat, lng);
            const result = getAnalysisScore(rawData, buildingType);
            
            const finalColor = getColorForScore(result.finalScore);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É
            L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: <div style="background-color: ${finalColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            })
            .bindPopup(`
                <h3>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ $\zeta$: ${locationName}</h3>
                <b>–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê $\mathcal{S}_{final}$: <span style="color:${finalColor};">${result.finalScore}/100</span></b>
                <hr style="margin: 5px 0;">
                <b>–í–ï–†–î–ò–ö–¢: ${result.finalVerdict.text}</b>
                <br><small>${result.finalVerdict.sub}</small>
            `)
            .openPopup()
            .addTo(markers);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
            const formatFactors = (factors) => {
                if (factors.length === 0) return '<li><span style="color: #00BFFF;">–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. (–û—Ü–µ–Ω–∫–∞ $100$)</span></li>';
                return factors.map(f => <li>${f}</li>).join('');
            };

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
            currentReportDiv.innerHTML = `
                <h4>–û—Ç—á–µ—Ç #${markerCount}: –¢–æ—á–µ—á–Ω—ã–π –ê—É–¥–∏—Ç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã $\zeta$ - ${locationName} (${buildingNameText})</h4>
                
                <div class="verdict" style="background-color: ${result.finalVerdict.color};">
                    ${result.finalVerdict.text} <br>
                    <span style="font-size: 0.8em; font-weight: normal;">${result.finalVerdict.sub}</span>
                </div>

                <p style="margin: 15px 0;">
                    <span style="font-size: 1.1em; font-weight: 600; color: #00BFFF;">–ò–¢–û–ì–û–í–´–ô –û–¶–ï–ù–û–ß–ù–´–ô –ë–ê–õ–õ $\mathcal{S}_{final}$:</span> 
                    <span class="score-box" style="background-color: ${finalColor};">${result.finalScore}/100</span>
                </p>

                <!-- –ù–û–í–´–ô –ë–õ–û–ö: –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï (–†–Ø–î–û–ú –° –û–¶–ï–ù–ö–û–ô) -->
                <div class="geo-data-grid grid grid-cols-2 gap-4">
                    <div class="geo-item">
                        <p>–¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—è & –°–∫–ª–æ–Ω</p>
                        <p><strong>${rawData.maxSlope}$^\circ$</strong> (–ü–ª–æ—Å–∫–æ—Å—Ç—å: ${rawData.flatnessPercentage}\%)</p>
                    </div>
                    <div class="geo-item">
                        <p>–ü–æ—á–≤–µ–Ω–Ω—ã–π –†–µ–∂–∏–º</p>
                        <p><strong>${rawData.envProfile.soil.type}</strong> (${rawData.envProfile.soil.suitability})</p>
                    </div>
                    <div class="geo-item">
                        <p>–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –í—ã—Å–æ—Ç–∞</p>
                        <p><strong>${rawData.altitude} –º.</strong></p>
                    </div>
                    <div class="geo-item">
                        <p>–ß–∏—Å—Ç–æ—Ç–∞ –í–æ–∑–¥—É—Ö–∞ (PM2.5)</p>
                        <p><b style="color: ${rawData.envProfile.environment.airQuality.includes('–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–∞—è') ? '#FF5733' : '#4CAF50'};">${rawData.envProfile.environment.airQuality}</b></p>
                    </div>
                    <div class="geo-item col-span-2">
                        <p>–ö–ª–∏–º–∞—Ç & –ü–ª–æ—Ç–Ω–æ—Å—Ç—å</p>
                        <p><strong>$\text{T}_{avg}$: ${rawData.envProfile.climate.avgTemp}</strong> | $\rho$: ${rawData.populationDensity} —á–µ–ª/–∫–º$^2$</p>
                    </div>
                </div>
                <!-- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê -->

                <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è $R$-—Ñ–∞–∫—Ç–æ—Ä–æ–≤ -->
                <div class="report-section" style="margin-top: 25px; border-color: #F44336;">
                    <h4>1. –í–µ–∫—Ç–æ—Ä –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (40%) $\mathcal{R}_{safety}$ | –û—Ü–µ–Ω–∫–∞: ${result.report.safety.score}/100</h4>
                    <ul class="report-factors" style="list-style-type: none; padding-left: 0;">
                        ${formatFactors(result.report.safety.factors)}
                    </ul>
                </div>

                <div class="report-section" style="border-color: #FFC107;">
                    <h4>2. –í–µ–∫—Ç–æ—Ä –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (25%) $\mathcal{R}_{sustain}$ | –û—Ü–µ–Ω–∫–∞: ${result.report.sustainability.score}/100</h4>
                    <ul class="report-factors" style="list-style-type: none; padding-left: 0;">
                        ${formatFactors(result.report.sustainability.factors)}
                    </ul>
                </div>

                <div class="report-section" style="border-color: #4CAF50;">
                    <h4>3. –í–µ–∫—Ç–æ—Ä –ó–¥–æ—Ä–æ–≤—å—è & –ö–ª–∏–º–∞—Ç–∞ (20%) $\mathcal{R}_{health}$ | –û—Ü–µ–Ω–∫–∞: ${result.report.healthClimate.score}/100</h4>
                    <ul class="report-factors" style="list-style-type: none; padding-left: 0;">
                        ${formatFactors(result.report.healthClimate.factors)}
                    </ul>
                </div>

                <div class="report-section" style="border-color: #00BFFF;">
                    <h4>4. –í–µ–∫—Ç–æ—Ä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (15%) $\mathcal{R}_{eff}$ | –û—Ü–µ–Ω–∫–∞: ${result.report.efficiency.score}/100</h4>
                    <ul class="report-factors" style="list-style-type: none; padding-left: 0;">
                        ${formatFactors(result.report.efficiency.factors)}
                    </ul>
                </div>
            `;
        }

        // --- V25: –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É ---
        function handleStreetSearch() {
            const searchInput = document.getElementById('street_search').value.toLowerCase().trim();
            const feedbackDiv = document.getElementById('search_feedback');
            const buildingType = document.getElementById('building_type').value;

            const foundKey = Object.keys(STREET_COORDINATES).find(key => searchInput.includes(key));
            
            feedbackDiv.style.color = '#FFC107';
            feedbackDiv.innerText = "‚è≥ –ò–¥–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...";

            if (foundKey) {
                const coord = STREET_COORDINATES[foundKey];
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ
                map.setView([coord.lat, coord.lng], 14); 

                // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞
                simulateMarkerAnalysis(coord.lat, coord.lng, buildingType, coord.name);

                feedbackDiv.style.color = '#4CAF50';
                feedbackDiv.innerText = ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã $\zeta$ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${coord.name}. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ê—É–¥–∏—Ç #${markerCount}.;
            } else {
                feedbackDiv.style.color = '#F44336';
                feedbackDiv.innerText = "‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–∞–∑–µ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç V25. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ (–ß—É–π, –ú–∞–Ω–∞—Å–∞, –ò—Å—Å—ã–∫-–ö—É–ª—å, –û—à).";
            }
        }
        
        // --- V25: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ü–æ–ª–∏–≥–æ–Ω–æ–º (–õ–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö) ---
        
        function isPointInPolygon(point, vs) {
            var x = point.lng, y = point.lat;
            var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i].lng, yi = vs[i].lat;
                var xj = vs[j].lng, yj = vs[j].lat;
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        async function startAreaAnalysis(finalPoly) {
            markerCount++;
            const markerId = area_marker_${markerCount};
            const buildingType = document.getElementById('building_type').value;
            const buildingName = document.getElementById('building_type').options[document.getElementById('building_type').selectedIndex].text;
            const numSamples = 15; // –£–≤–µ–ª–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±–æ—Ä–æ–∫ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
            const resultsDiv = document.getElementById('results');
            
            const bounds = finalPoly.getBounds();
            const vertices = finalPoly.getLatLngs()[0]; 

            finalPoly.bindPopup(*–û–±–ª–∞—Å—Ç—å #${markerCount}:* ${buildingName}<br>‚è≥ –ò–¥–µ—Ç –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ó–æ–Ω—ã...).openPopup();

            const newReportHtml = `<div id="${markerId}" class="result-card">
                <h4>–û—Ç—á–µ—Ç #${markerCount}: –ó–æ–Ω–∞–ª—å–Ω—ã–π –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ê—É–¥–∏—Ç (${buildingName})</h4>
                <p><strong>–°—Ä–µ–¥–Ω—è—è –û—Ü–µ–Ω–∫–∞:</strong> <span class="score-box" style="background-color: gray;">...</span></p>
            </div>`;
            resultsDiv.innerHTML = newReportHtml + resultsDiv.innerHTML;
            const currentReportDiv = document.getElementById(markerId);
            
            let allScores = [];
            let allSafetyScores = [];
            let hardStopCount = 0;
            let firstSampledData = null; // –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è

            currentReportDiv.innerHTML += <p style="font-style: italic; color: #B3C1CC;">–ò–¥–µ—Ç –≤—ã–±–æ—Ä–∫–∞ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ${numSamples} –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ (Enhanced Module)...</p>;

            let pointsFound = 0;
            let attempts = 0;
            const maxAttempts = 500; 

            while (pointsFound < numSamples && attempts < maxAttempts) {
                attempts++;
                
                const latRange = bounds.getNorth() - bounds.getSouth();
                const lngRange = bounds.getEast() - bounds.getWest();

                const randomLat = bounds.getSouth() + Math.random() * latRange;
                const randomLng = bounds.getWest() + Math.random() * lngRange;
                const sampleLatLng = L.latLng(randomLat, randomLng);

                if (isPointInPolygon(sampleLatLng, vertices)) {
                    pointsFound++;
                    
                    // –ù–û–í–´–ô –í–´–ó–û–í –§–£–ù–ö–¶–ò–ò
                    const rawData = await fetchGeospatialData(sampleLatLng.lat, sampleLatLng.lng);
                    const result = getAnalysisScore(rawData, buildingType);
                    
                    if (!firstSampledData) {
                         firstSampledData = rawData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                    }

                    allScores.push(result.finalScore);
                    allSafetyScores.push(result.safetyScore);

                    if (result.finalScore === 0) {
                        hardStopCount++;
                        L.circleMarker(sampleLatLng, { radius: 4, color: '#F44336', fillOpacity: 1 }).addTo(markers)
                            .bindPopup(*–¢–æ—á–∫–∞ ${pointsFound} (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó):* ${result.finalVerdict.sub});
                    } else {
                        L.circleMarker(sampleLatLng, { radius: 2, color: getColorForScore(result.finalScore), fillOpacity: 1 }).addTo(markers);
                    }
                }
            }
            
            if (attempts === maxAttempts) {
                 currentReportDiv.innerHTML += <p style="color: #FF9800;">‚ö† *–í–Ω–∏–º–∞–Ω–∏–µ:* –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–±—Ä–∞—Ç—å ${numSamples} —Ç–æ—á–µ–∫. –ó–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º.</p>;
            }

            const avgScore = (pointsFound === 0) ? 0 : allScores.reduce((a, b) => a + b, 0) / pointsFound;
            const minScore = (pointsFound === 0) ? 0 : Math.min(...allScores);
            const minSafetyScore = (pointsFound === 0) ? 0 : Math.min(...allSafetyScores);

            const finalColor = getColorForScore(avgScore);
            
            let finalVerdict = { text: '–ê–£–î–ò–¢ –ü–†–û–ô–î–ï–ù: –í–´–°–û–ö–ò–ô –ü–û–¢–ï–ù–¶–ò–ê–õ', color: '#4CAF50', sub: –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${avgScore.toFixed(0)}/100. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: ${minScore}/100. }; 
            
            if (hardStopCount > 0) {
                finalVerdict = { 
                    text: '–ê–£–î–ò–¢: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó', 
                    color: '#F44336', 
                    sub: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${hardStopCount} –Ω–∞—Ä—É—à–µ–Ω–∏–π –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞ (–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ó–∞–ø—Ä–µ—Ç). 
                };
            } else if (minSafetyScore < 50 || avgScore < 70) { 
                 finalVerdict = { 
                    text: '–ê–£–î–ò–¢: –ù–ò–ó–ö–ê–Ø –†–ï–ù–¢–ê–ë–ï–õ–¨–ù–û–°–¢–¨', 
                    color: '#FF9800', 
                    sub: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: ${minScore}/100. –í—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é —Ä–∏—Å–∫–æ–≤. 
                };
            } else if (avgScore < 85) { 
                finalVerdict = { text: '–ê–£–î–ò–¢: –ü–†–ò–ï–ú–õ–ï–ú–´–ô (–¢–†–ï–ë–£–ï–¢–°–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø)', color: '#FFC107', sub: –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${avgScore.toFixed(0)}/100. –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏. };
            }

            finalPoly.setPopupContent(`
                <h3>–û–±–ª–∞—Å—Ç—å #${markerCount}: ${buildingName}</h3>
                <b>–°–†–ï–î–ù–ò–ô –û–¶–ï–ù–û–ß–ù–´–ô –ë–ê–õ–õ: <span style="color:${finalColor};">${avgScore.toFixed(0)}/100</span></b>
                <hr style="margin: 5px 0;">
                <b>–ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢: ${finalVerdict.text}</b>
            `).openPopup();
            
            currentReportDiv.querySelector('.score-box').style.backgroundColor = finalColor;
            currentReportDiv.querySelector('.score-box').innerText = ${avgScore.toFixed(0)}/100;

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏)
            let geoDataHtml = ``;
            if (firstSampledData) {
                geoDataHtml = `
                    <div class="geo-data-grid grid grid-cols-2 gap-4">
                        <div class="geo-item">
                            <p>–î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π –°–∫–ª–æ–Ω</p>
                            <p><strong>${firstSampledData.maxSlope}$^\circ$</strong> (–ü–ª–æ—Å–∫–æ—Å—Ç—å: ${firstSampledData.flatnessPercentage}\%)</p>
                        </div>
                        <div class="geo-item">
                            <p>–î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π –¢–∏–ø –ü–æ—á–≤—ã</p>
                            <p><strong>${firstSampledData.envProfile.soil.type}</strong> (${firstSampledData.envProfile.soil.suitability})</p>
                        </div>
                        <div class="geo-item">
                            <p>–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –í—ã—Å–æ—Ç–∞ (–°—Ä–µ–¥.)</p>
                            <p><strong>${firstSampledData.altitude} –º.</strong></p>
                        </div>
                        <div class="geo-item">
                            <p>–î–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è –ß–∏—Å—Ç–æ—Ç–∞ –í–æ–∑–¥—É—Ö–∞</p>
                            <p><b style="color: ${firstSampledData.envProfile.environment.airQuality.includes('–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–∞—è') ? '#FF5733' : '#4CAF50'};">${firstSampledData.envProfile.environment.airQuality}</b></p>
                        </div>
                         <div class="geo-item col-span-2">
                            <p>–ö–ª–∏–º–∞—Ç & –ü–ª–æ—Ç–Ω–æ—Å—Ç—å</p>
                            <p><strong>$\text{T}{avg}$: ${firstSampledData.envProfile.climate.avgTemp}</strong> | $\rho{avg}$: ${firstSampledData.populationDensity} —á–µ–ª/–∫–º$^2$</p>
                        </div>
                    </div>
                    <small style="color:#B3C1CC; display:block; margin-top: 10px;">* –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ü—Ä–æ—Ñ–∏–ª—å –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –∫–ª—é—á–µ–≤–æ–π (–ø–µ—Ä–≤–æ–π) —Ç–æ—á–∫–∏ –∑–æ–Ω—ã.</small>
                `;
            } else {
                geoDataHtml = <p style="color: #FF9800;">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ—Ñ–∏–ª–µ –∑–æ–Ω—ã.</p>;
            }

            currentReportDiv.innerHTML = `
                <h4>–û—Ç—á–µ—Ç #${markerCount}: –ó–æ–Ω–∞–ª—å–Ω—ã–π –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ê—É–¥–∏—Ç (${buildingName})</h4>
                
                <div class="verdict" style="background-color: ${finalVerdict.color};">
                    ${finalVerdict.text} <br>
                    <span style="font-size: 0.8em; font-weight: normal;">${finalVerdict.sub}</span>
                </div>

                <p style="margin: 15px 0;">
                    <span style="font-size: 1.1em; font-weight: 600; color: #00BFFF;">–°–†–ï–î–ù–ò–ô –û–¶–ï–ù–û–ß–ù–´–ô –ë–ê–õ–õ $\mathcal{S}_{final}$:</span> 
                    <span class="score-box" style="background-color: ${finalColor};">${avgScore.toFixed(0)}/100</span>
                    <br>
                    <small style="margin-left: 10px; color: #B3C1CC;">
                        –ú–∏–Ω. –±–∞–ª–ª –≤ –≤—ã–±–æ—Ä–∫–µ: <b>${minScore}/100</b> | –ù–∞—Ä—É—à–µ–Ω–∏–π –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞: <b>${hardStopCount}</b>
                    </small>
                </p>
                
                <div class="report-section">
                    <h4>üó∫ –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ü—Ä–æ—Ñ–∏–ª—å –ó–æ–Ω—ã (–°–≤–æ–¥–Ω—ã–π)</h4>
                    ${geoDataHtml}
                </div>

                <div class="report-section">
                    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ó–æ–Ω—ã</h4>
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li>–ö–æ–ª-–≤–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫: ${pointsFound}</li>
                        <li>–ì–µ–æ–º–µ—Ç—Ä–∏—è: –ü–æ–ª–∏–≥–æ–Ω (${vertices.length} –≤–µ—Ä—à–∏–Ω)</li>
                    </ul>
                </div>
            `;
            
            isDrawingPolygon = false; 
        }

        // --- –õ–û–ì–ò–ö–ê –†–ò–°–û–í–ê–ù–ò–Ø –ü–û–õ–ò–ì–û–ù–ê ---
        function activatePolygonMode() {
            isDrawingPolygon = !isDrawingPolygon;
            
            if (isDrawingPolygon) {
                polygonPoints = [];
                polygonMarkers.clearLayers();
                if (currentPolyline) {
                    markers.removeLayer(currentPolyline);
                    currentPolyline = null;
                }
                map.getContainer().classList.add('drawing-cursor');
                document.getElementById('search_feedback').innerText = "‚úÖ –†–µ–∂–∏–º –ó–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ê–Ω–∞–ª–∏–∑–∞ –ê–∫—Ç–∏–≤–µ–Ω. –ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—à–∏–Ω—É. –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–¥–∏—Ç.";
            } else {
                map.getContainer().classList.remove('drawing-cursor');
                document.getElementById('search_feedback').innerText = "–†–µ–∂–∏–º –ê–Ω–∞–ª–∏–∑–∞ –í—ã–∫–ª—é—á–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.";
            }
        }
        
        map.on('click', function(e) {
            if (!isDrawingPolygon) return;
            const latlng = e.latlng;
            polygonPoints.push(latlng);
            L.circleMarker(latlng, {
                radius: 5,
                color: '#00BFFF',
                fillColor: '#00BFFF',
                fillOpacity: 1
            }).addTo(polygonMarkers);

            if (currentPolyline) {
                currentPolyline.setLatLngs(polygonPoints);
            } else {
                currentPolyline = L.polyline(polygonPoints, { color: '#4CAF50', weight: 3, dashArray: '8, 4' }).addTo(markers);
            }
        });

        map.on('dblclick', function(e) {
            if (!isDrawingPolygon) return;
            if (polygonPoints.length < 3) {
                document.getElementById('search_feedback').innerText = "‚ö† –û—à–∏–±–∫–∞ –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞: –î–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–æ–Ω—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 3 –≤–µ—Ä—à–∏–Ω—ã.";
                return;
            }
            
            isDrawingPolygon = false;
            map.getContainer().classList.remove('drawing-cursor');
            
            if (currentPolyline) {
                markers.removeLayer(currentPolyline);
            }
            polygonMarkers.clearLayers();
            currentPolyline = null;
            
            const finalPoly = L.polygon(polygonPoints, { color: '#00BFFF', weight: 3, fillOpacity: 0.1, fillColor: '#00BFFF' });
            drawnPolygons.addLayer(finalPoly);
            
            startAreaAnalysis(finalPoly);
            polygonPoints = [];
        });

        // --- –û–±—â–∞—è –æ—á–∏—Å—Ç–∫–∞ ---
        function clearAllMarkers() {
            markers.clearLayers();
            polygonMarkers.clearLayers();
            drawnPolygons.clearLayers();
            document.getElementById('results').innerHTML = '';
            markerCount = 0;
            if (isDrawingPolygon) {
                activatePolygonMode(); // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
            }
            document.getElementById('search_feedback').innerText = "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤–æ–º—É –ê—É–¥–∏—Ç—É.";
            map.setView([42.8744, 74.5980], 12); // –°–±—Ä–æ—Å –≤–∏–¥–∞ –Ω–∞ –ë–∏—à–∫–µ–∫
        }

    </script>
</body>
</html>