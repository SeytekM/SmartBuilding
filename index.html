<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä SmartBuilding - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ó–æ–Ω—ã –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ V16</title>
    
    <!-- 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS (–ö–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* 2. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ CSS –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #f0ffef; }
        header { background-color: #004d40; color: white; padding: 15px 20px; text-align: center; border-bottom: 5px solid #00796b; }
        #map { 
            height: 60vh; 
            width: 100%; 
            border-bottom: 3px solid #004d40; 
            filter: brightness(0.95);
            transition: filter 0.5s;
        }
        #controls { padding: 20px; background: #ffffff; box-shadow: 0 -2px 10px rgba(0,0,0,0.15); border-radius: 8px 8px 0 0; }
        h2 { color: #00796b; border-bottom: 2px solid #e0f2f1; padding-bottom: 5px; margin-top: 0; }
        .control-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        button { 
            background-color: #388e3c; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            font-size: 16px; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #2e7d32; }
        #clear-button { background-color: #d32f2f; }
        #clear-button:hover { background-color: #c62828; }
        .search-group input { flex-grow: 1; min-width: 250px; }
        
        #results { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; }
        .score-box { 
            font-size: 2em; 
            font-weight: bold; 
            display: inline-block; 
            padding: 8px 12px; 
            border-radius: 5px; 
            color: white;
            min-width: 80px;
            text-align: center;
        }
        .report-section { border: 1px solid #e0f2f1; padding: 15px; margin-top: 10px; border-radius: 6px; }
        .report-section h4 { margin: 0 0 10px 0; color: #00796b; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; }

        .verdict {
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            border-radius: 8px;
            margin-top: 20px;
            color: white;
        }
    </style>
</head>
<body>

    <header>
        <h1>SmartBuilding (V16 - –£–º–Ω—ã–π –ü–æ–∏—Å–∫ –ø–æ –£–ª–∏—Ü–∞–º) üåç</h1>
        <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –≥–µ–æ–∞–Ω–∞–ª–∏–∑: —Ä–∏—Å–∫–∏, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –∑–¥–æ—Ä–æ–≤—å–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. **–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ —É–ª–∏—Ü–∞–º –ë–∏—à–∫–µ–∫–∞.**</p>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã: –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ - –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω -->
    <div id="map"></div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="controls">
        <h2>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
        
        <!-- –ì—Ä—É–ø–ø–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —É–ª–∏—Ü–∞–º (–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è) -->
        <div class="control-group search-group" style="border-bottom: 1px solid #e0f2f1; padding-bottom: 15px;">
            <label for="street_search" style="font-weight: bold;">üîé –ü–æ–∏—Å–∫ –ø–æ —É–ª–∏—Ü–µ (–ë–∏—à–∫–µ–∫/–ì–æ—Ä–æ–¥–∞):</label>
            <input type="text" id="street_search" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß—É–π, –ú–∞–Ω–∞—Å–∞, –ë–∞–π—Ç–∏–∫ –±–∞–∞—Ç—ã—Ä–∞ –∏–ª–∏ –û—à, –ö–∞—Ä–∞–∫–æ–ª" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
            <button onclick="handleStreetSearch()" style="background-color: #00796b;">
                –ù–∞–π—Ç–∏ –∏ –û—Ü–µ–Ω–∏—Ç—å
            </button>
            <div id="search_feedback" style="margin-top: 5px; color: #d32f2f; width: 100%;"></div>
        </div>

        <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞ -->
        <div class="control-group" style="margin-top: 15px;">
            <label for="building_type" style="margin-right: 15px;">–¢–∏–ø –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:</label>
            <select id="building_type" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="residential_block">–ñ–∏–ª–æ–π –º–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –¥–æ–º</option>
                <option value="hospital">–ë–æ–ª—å–Ω–∏—Ü–∞ / –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)</option>
                <option value="school">–®–∫–æ–ª–∞ / –î–µ—Ç—Å–∫–∏–π —Å–∞–¥ (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –±–æ–ª–µ–∑–Ω—è–º/—Å—Ä–µ–¥–µ)</option>
                <option value="industrial">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç / –ó–∞–≤–æ–¥ (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –ª–æ–≥–∏—Å—Ç–∏–∫–µ)</option>
                <option value="wind_farm">–í–µ—Ç—Ä—è–Ω–∞—è —Ñ–µ—Ä–º–∞ / –≠–Ω–µ—Ä–≥–æ–æ–±—ä–µ–∫—Ç (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –≤–µ—Ç—Ä—É/—Ä–µ–ª—å–µ—Ñ—É)</option>
            </select>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
        <div class="control-group">
            <button onclick="activatePlacementMode()">
                üìå –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∏ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –û–±—ä–µ–∫—Ç (–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ)
            </button>
            <button id="clear-button" onclick="clearAllMarkers()">
                ‚ùå –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
            </button>
        </div>

        <div id="results">
            <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- 4. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ -->
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã, —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ë–∏—à–∫–µ–∫–µ
        var map = L.map('map').setView([42.8744, 74.5980], 12); 
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ —Å–ª–æ—è OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        var markers = L.layerGroup().addTo(map); 
        var placementMode = false;
        var markerCount = 0;
        
        // --- V16: –ë–ê–ó–ê –ö–û–û–†–î–ò–ù–ê–¢ –î–õ–Ø –ò–ú–ò–¢–ê–¶–ò–ò –ì–ï–û–ö–û–î–ò–†–û–í–ê–ù–ò–Ø ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —É–ª–∏—Ü–∞–º –∏ –≥–æ—Ä–æ–¥–∞–º –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞.
        const STREET_COORDINATES = {
            "—á—É–π": { lat: 42.875, lng: 74.60, name: "–ü—Ä–æ—Å–ø–µ–∫—Ç –ß—É–π (–¶–µ–Ω—Ç—Ä –ë–∏—à–∫–µ–∫–∞)" },
            "–º–∞–Ω–∞—Å–∞": { lat: 42.878, lng: 74.575, name: "–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∞–Ω–∞—Å–∞" },
            "–±–∞–π—Ç–∏–∫ –±–∞–∞—Ç—ã—Ä–∞": { lat: 42.845, lng: 74.615, name: "–£–ª–∏—Ü–∞ –ë–∞–π—Ç–∏–∫ –ë–∞–∞—Ç—ã—Ä–∞" },
            "–∂–∏–±–µ–∫ –∂–æ–ª—É": { lat: 42.885, lng: 74.620, name: "–ü—Ä–æ—Å–ø–µ–∫—Ç –ñ–∏–±–µ–∫-–ñ–æ–ª—É" },
            "—ç—Ä–∫–∏–Ω–¥–∏–∫": { lat: 42.868, lng: 74.605, name: "–ë—É–ª—å–≤–∞—Ä –≠—Ä–∫–∏–Ω–¥–∏–∫" },
            "–∞—Ö—É–Ω–±–∞–µ–≤–∞": { lat: 42.819, lng: 74.610, name: "–£–ª–∏—Ü–∞ –ê—Ö—É–Ω–±–∞–µ–≤–∞ (–Æ–∂–Ω–∞—è —á–∞—Å—Ç—å)" },
            "–æ—à": { lat: 40.510, lng: 72.800, name: "–¶–µ–Ω—Ç—Ä –û—à–∞" },
            "–∫–∞—Ä–∞–∫–æ–ª": { lat: 42.483, lng: 78.393, name: "–¶–µ–Ω—Ç—Ä –ö–∞—Ä–∞–∫–æ–ª–∞" }
        };

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ —Ü–≤–µ—Ç–∞ –æ—Ü–µ–Ω–∫–∏ ---
        function getColorForScore(score) {
            if (score >= 90) return '#1b5e20'; // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ (–∑–µ–ª–µ–Ω—ã–π)
            if (score >= 75) return '#ffa000'; // –ü—Ä–∏–µ–º–ª–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
            if (score >= 50) return '#cc5500'; // –ù–µ—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (—Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
            return '#b71c1c'; // –ó–∞–ø—Ä–µ—â–µ–Ω–æ (–∫—Ä–∞—Å–Ω—ã–π)
        }

        // --- –§—É–Ω–∫—Ü–∏—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –î–∞–Ω–Ω—ã–º (–°–ò–ú–£–õ–Ø–¶–ò–Ø) ---
        // –ò–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–ª—å–µ—Ñ–µ, –∫–ª–∏–º–∞—Ç–µ, —Å–µ–π—Å–º–∏–∫–µ –∏ —Ç.–¥.
        async function fetchNASAData(lat, lng) {
            // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ API
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            const absLat = Math.abs(lat);
            let landCoverCategory = 'LAND_SIMULATED'; 
            
            // --- 1. –ü–†–û–í–ï–†–ö–ò –ê–ë–°–û–õ–Æ–¢–ù–û–ì–û –ó–ê–ü–†–ï–¢–ê (Hard Stops) ---
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã (–í–æ–¥–∞, –õ–µ–¥–Ω–∏–∫–∏, –í—ã—Å–æ—Ç–∞)
            if (lat >= 70 || lat <= -60) { landCoverCategory = 'GLACIER/ICE_SHEET'; }
            else if ((lat > 41.5 && lat < 43.5 && lng > 76.0 && lng < 79.0)) { landCoverCategory = 'WATER_LAKE'; } // –ò—Å—Å—ã–∫-–ö—É–ª—å
            
            // –ñ–ï–°–¢–ö–ò–ô –°–¢–û–ü –î–õ–Ø –õ–Æ–ë–û–ì–û –ö–õ–ò–ö–ê –ù–ê –í–û–î–£ (–û–±—â–∞—è –∏–º–∏—Ç–∞—Ü–∏—è)
            if (landCoverCategory === 'LAND_SIMULATED' && Math.random() < 0.05) {
                 landCoverCategory = 'WATER_LAKE'; 
            }

            // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• (–¢–û–õ–¨–ö–û –ï–°–õ–ò –≠–¢–û –ó–ï–ú–õ–Ø) ---
            let maxSlope = 10 + Math.random() * 20; 
            let windSpeed = 5 + Math.random() * 10; 
            let populationDensity = 10 + Math.random() * 400; 
            let envStress = '–£–º–µ—Ä–µ–Ω–Ω–∞—è';
            let diseasePrevalence = 1.0 + Math.random() * 4.0; 
            let seismicRisk = '–°—Ä–µ–¥–Ω–∏–π'; 
            let roadProximity = '–ü–ª–æ—Ö–æ (–±–æ–ª–µ–µ 10 –∫–º)'; 
            let naturalDisasterRisk = '–°—Ä–µ–¥–Ω–∏–π'; 
            let altitude = 100 + Math.random() * 4000; 
            let isUrbanPlateau = false; 

            
            if (landCoverCategory.startsWith('WATER_') || landCoverCategory === 'GLACIER/ICE_SHEET') {
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
                altitude = (landCoverCategory.startsWith('WATER_')) ? -10 : 4000; 
                roadProximity = '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ';
                seismicRisk = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π';
                naturalDisasterRisk = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–ù–∞–≤–æ–¥–Ω–µ–Ω–∏—è/–ú–µ—Ä–∑–ª–æ—Ç–∞)';
                maxSlope = 0;
                windSpeed = 0;
                populationDensity = 0;
                diseasePrevalence = 0.0;
                envStress = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–í–æ–¥–∞';
            }
            
            else { 
                // --- –õ–û–ì–ò–ö–ê –ì–û–†–û–î–û–í –í –ü–†–ï–î–ì–û–†–¨–Ø–• (–ë–∏—à–∫–µ–∫, –û—à –∏ –∞–Ω–∞–ª–æ–≥–∏) ---
                if (altitude >= 1000 && altitude < 3500 && absLat > 25 && absLat < 60) {
                    
                    // –°–∏–º—É–ª—è—Ü–∏—è –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å—Ä–µ–¥—ã
                    populationDensity = 300 + Math.random() * 500; 
                    roadProximity = (Math.random() < 0.95) ? '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)' : '–•–æ—Ä–æ—à–æ (2-5 –∫–º)';
                    
                    maxSlope = 1 + Math.random() * 2; 
                    seismicRisk = '–í—ã—Å–æ–∫–∏–π'; // –¢–∏–ø–∏—á–Ω–æ –¥–ª—è –≥–æ—Ä–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
                    naturalDisasterRisk = '–í—ã—Å–æ–∫–∏–π (–û–ø–æ–ª–∑–Ω–∏/–ö–∞–º–Ω–µ–ø–∞–¥—ã)'; 

                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –¥–ª—è –ò–Ω–∂–µ–Ω–µ—Ä–Ω–æ–≥–æ –ü–ª–∞—Ç–æ (–¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —Å–µ–π—Å–º–∏–∫–∏)
                    if (maxSlope < 5 && roadProximity === '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)' && populationDensity > 300) {
                        isUrbanPlateau = true;
                    }
                }
            }
            
            const flatnessPercentage = (100 - parseFloat(maxSlope) * 1.5).toFixed(0); 

            return {
                landCoverType: '–°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä—É–Ω—Ç',
                maxSlope: parseFloat(maxSlope.toFixed(1)), 
                flatnessPercentage: parseFloat(flatnessPercentage),
                naturalDisasterRisk: naturalDisasterRisk,
                seismicRisk: seismicRisk,
                diseasePrevalence: parseFloat(diseasePrevalence.toFixed(1)),
                populationDensity: parseFloat(populationDensity.toFixed(0)),
                envStress: envStress,
                roadProximity: roadProximity,
                landTemp: 15 + Math.random() * 25, // –ò–º–∏—Ç–∞—Ü–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                windSpeed: parseFloat(windSpeed.toFixed(1)),
                altitude: parseFloat(altitude.toFixed(0)), 
                landCoverCategory: landCoverCategory, 
                lat: lat,
                lng: lng,
                isUrbanPlateau: isUrbanPlateau
            };
        }

        // --- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ê–ù–ê–õ–ò–ó) ---
        function getAnalysisScore(data, buildingType) {
            let safetyPenalty = 0;
            let sustainabilityPenalty = 0; 
            let healthPenalty = 0;
            let efficiencyBonus = 0;
            
            let baselinePenalty = 7; 
            safetyPenalty += baselinePenalty;

            let report = {
                safety: { score: 100, factors: [] },
                sustainability: { score: 100, factors: [] },
                healthClimate: { score: 100, factors: [] }, 
                efficiency: { score: 100, factors: [] },
            };
            
            // --- 1. –ü–†–û–í–ï–†–ö–ò –ê–ë–°–û–õ–Æ–¢–ù–û–ì–û –ó–ê–ü–†–ï–¢–ê (Hard Stops) ---
            if (data.landCoverCategory.startsWith('WATER_') || data.landCoverCategory === 'GLACIER/ICE_SHEET' || data.altitude > 3500 || data.roadProximity === '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ') { 
                
                let reason = (data.landCoverCategory.startsWith('WATER_')) ? '–í–æ–¥–Ω–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å' : 
                             (data.landCoverCategory === 'GLACIER/ICE_SHEET') ? '–õ–µ–¥–Ω–∏–∫/–ú–µ—Ä–∑–ª–æ—Ç–∞' : 
                             (data.altitude > 3500) ? '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã ($>3500$ –º)' : 
                             '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞';

                report.safety.factors.push('**–ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢:** –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —É—Å–ª–æ–≤–∏—è–º–∏.');
                return {
                    finalScore: 0,
                    report, 
                    finalVerdict: { text: '–°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û –ù–ï–í–û–ó–ú–û–ñ–ù–û', color: '#b71c1c', sub: `–ü—Ä–∏—á–∏–Ω–∞: ${reason}` }
                };
            }

            let hardStopWarning = false; 

            // --- –ò–ù–ñ–ï–ù–ï–†–ù–´–ô –ë–û–ù–£–° (–ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø –†–ò–°–ö–ê –î–õ–Ø –ì–û–†–û–î–û–í) ---
            if (data.isUrbanPlateau) {
                const safetyBoost = 25;
                safetyPenalty -= safetyBoost;
                report.safety.factors.push(`**–ò–ù–ñ–ï–ù–ï–†–ù–´–ô –ë–û–ù–£–°:** –ì–æ—Ä–æ–¥—Å–∫–æ–µ –ø–ª–∞—Ç–æ/–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å. (+${safetyBoost})`);
            }

            // --- 2. –ê–ù–ê–õ–ò–ó –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (SAFETY & DISASTER RISK) - –í–ï–° 35% ---
            
            // –°–µ–π—Å–º–∏–∫–∞
            if (data.seismicRisk === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π') { safetyPenalty += 70; report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫. (-70)'); } 
            else if (data.seismicRisk === '–í—ã—Å–æ–∫–∏–π') { safetyPenalty += 45; report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫. (-45)'); } 
            else if (data.seismicRisk === '–°—Ä–µ–¥–Ω–∏–π') { safetyPenalty += 15; report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫. (-15)'); }

            // –†–µ–ª—å–µ—Ñ/–ë–µ–¥—Å—Ç–≤–∏—è
            if (data.maxSlope > 30 || data.naturalDisasterRisk.includes('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π')) {
                 safetyPenalty += 80;
                 report.safety.factors.push(`**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö:** –û–ø–æ–ª–∑–Ω–∏/–õ–∞–≤–∏–Ω—ã/–°–∫–ª–æ–Ω—ã (${data.maxSlope}¬∞). (-80)`);
                 hardStopWarning = true; 
            } else if (data.maxSlope > 15) {
                 safetyPenalty += 20; 
                 report.safety.factors.push(`–†–µ–ª—å–µ—Ñ: –ö—Ä—É—Ç–æ–π —Å–∫–ª–æ–Ω (${data.maxSlope}¬∞). (-20)`);
            }
            
            // –°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
            if (buildingType === 'hospital' && data.seismicRisk === '–í—ã—Å–æ–∫–∏–π') { safetyPenalty += 15; report.safety.factors.push('**–ë–æ–ª—å–Ω–∏—Ü–∞:** –î–æ–ø. —à—Ç—Ä–∞—Ñ –∑–∞ —Å–µ–π—Å–º–∏–∫—É. (-15)'); }
            
            // --- 3. –ê–ù–ê–õ–ò–ó –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò (SUSTAINABILITY & DEMOGRAPHY) - –í–ï–° 25% ---
            
            // –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å vs –°—Ä–µ–¥–∞
            if (data.populationDensity > 800) { sustainabilityPenalty += 55; report.sustainability.factors.push(`–î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å. (-55)`); } 
            else if (data.populationDensity < 50) { sustainabilityPenalty += 10; report.sustainability.factors.push(`–ü–ª–æ—Ç–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å. (-10)`); }
            
            // --- 4. –ê–ù–ê–õ–ò–ó –ó–î–û–†–û–í–¨–Ø –ò –≠–ö–û–õ–û–ì–ò–ò (HEALTH & MICROCLIMATE) - –í–ï–° 20% ---
            
            // –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å –±–æ–ª–µ–∑–Ω–µ–π
            if (data.diseasePrevalence > 4.5) { healthPenalty += 70; report.healthClimate.factors.push(`–ë–æ–ª–µ–∑–Ω–∏: –í—ã—Å–æ–∫–∞—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å (${data.diseasePrevalence}%). (-70)`); } 
            else if (data.diseasePrevalence > 3.0) { healthPenalty += 40; report.healthClimate.factors.push(`–ë–æ–ª–µ–∑–Ω–∏: –°—Ä–µ–¥–Ω—è—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å. (-40)`); }

            // LST (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)
            if (data.landTemp > 45 || data.landTemp < -15) { healthPenalty += 40; report.healthClimate.factors.push(`LST: –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (${data.landTemp}¬∞C). (-40)`); }
            
            // –°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ó–¥–æ—Ä–æ–≤—å–µ)
            if (buildingType === 'hospital' && data.diseasePrevalence > 3.0) { healthPenalty += 20; report.healthClimate.factors.push('**–ë–æ–ª—å–Ω–∏—Ü–∞:** –î–æ–ø. —à—Ç—Ä–∞—Ñ –∑–∞ –±–æ–ª–µ–∑–Ω–∏. (-20)'); }

            // --- 5. –ê–ù–ê–õ–ò–ó –í–´–ì–û–î–ù–û–°–¢–ò/–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò (EFFICIENCY) - –í–ï–° 20% ---

            // –õ–æ–≥–∏—Å—Ç–∏–∫–∞/–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            if (data.roadProximity === '–ü–ª–æ—Ö–æ (–±–æ–ª–µ–µ 10 –∫–º)') {
                efficiencyBonus -= 60; 
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –ß—Ä–µ–∑–º–µ—Ä–Ω–∞—è —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å (>10 –∫–º). (-60)');
            } else if (data.roadProximity === '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)') {
                efficiencyBonus += 15; 
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –ò–¥–µ–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å. (+15)');
            }
            
            // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¢–∏–ø—É –û–±—ä–µ–∫—Ç–∞
            if (buildingType === 'wind_farm') {
                if (data.windSpeed > 15) { efficiencyBonus += 35; report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª! (+35)'); } 
                else if (data.windSpeed < 7) { efficiencyBonus -= 50; report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –ù–∏–∑–∫–∏–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. (-50)'); }
            } else if (buildingType === 'hospital' && data.roadProximity !== '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)') {
                efficiencyBonus -= 30;
                report.efficiency.factors.push('**–ë–æ–ª—å–Ω–∏—Ü–∞:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å. (-30)');
            }


            // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤—ã—Ö –±–∞–ª–ª–æ–≤
            report.safety.score = Math.max(0, 100 - safetyPenalty).toFixed(0);
            report.sustainability.score = Math.max(0, 100 - sustainabilityPenalty).toFixed(0);
            report.healthClimate.score = Math.max(0, 100 - healthPenalty).toFixed(0);
            report.efficiency.score = Math.max(0, 100 + efficiencyBonus).toFixed(0);
            
            // –ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç: –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ (35/25/20/20)
            const finalScore = (
                0.35 * report.safety.score + 
                0.25 * report.sustainability.score + 
                0.20 * report.healthClimate.score +
                0.20 * report.efficiency.score 
            ).toFixed(0);


            // --- –§–ò–ù–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢–ò–í–ù–´–ô –í–ï–†–î–ò–ö–¢ (–ü–æ—Ä–æ–≥–∏) ---
            let finalVerdict = { text: '–û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–ï', color: '#1b5e20', sub: '–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—ã—à–µ 90: –†–∏—Å–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã, –ø—Ä–æ–µ–∫—Ç –≤—ã—Å–æ–∫–æ—Ä–µ–Ω—Ç–∞–±–µ–ª–µ–Ω.' }; 
            
            if (hardStopWarning || report.safety.score < 25 || finalScore < 50) { 
                finalVerdict = { text: '–°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û –ù–ï–í–û–ó–ú–û–ñ–ù–û (–ù–ï–°–û–í–ú–ï–°–¢–ò–ú–´–ï –†–ò–°–ö–ò)', color: '#b71c1c', sub: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º—ã–µ —Ä–∏—Å–∫–∏.' };
            } else if (finalScore < 75) { 
                 finalVerdict = { text: '–°–õ–û–ñ–ù–´–ô –ò –ù–ï–†–ê–¶–ò–û–ù–ê–õ–¨–ù–´–ô –ü–†–û–ï–ö–¢', color: '#ff6f00', sub: '–û—Ü–µ–Ω–∫–∞ –Ω–∏–∂–µ 75: –°–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–æ–≤ –≤—ã—Å–æ–∫–∞. –¢—Ä–µ–±—É–µ–º—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –º–æ–≥—É—Ç —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–µ—Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ã–º.' };
            } else if (finalScore < 90) { 
                finalVerdict = { text: '–ü–†–ò–ï–ú–õ–ï–ú–´–ô –í–ê–†–ò–ê–ù–¢ (–¢–†–ï–ë–£–ï–¢–°–Ø –ê–£–î–ò–¢)', color: '#ffd600', sub: '–û—Ü–µ–Ω–∫–∞ 75-89: –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏.' };
            }


            return { finalScore, report, finalVerdict };
        }
        
        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ —É–ª–∏—Ü–∞–º ---
        function simulateStreetSearch(query) {
            const normalizedQuery = query.trim().toLowerCase();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ—á–Ω–æ–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            for (const key in STREET_COORDINATES) {
                // –ò—â–µ–º –ø–æ –∫–ª—é—á—É (—á—É–π) –∏–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ü—Ä–æ—Å–ø–µ–∫—Ç –ß—É–π...)
                if (normalizedQuery.includes(key) || STREET_COORDINATES[key].name.toLowerCase().includes(normalizedQuery)) {
                    return STREET_COORDINATES[key];
                }
            }
            return null;
        }

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–ª–∏–∫–∞ –∏ –¥–ª—è –ø–æ–∏—Å–∫–∞) ---
        async function startAnalysisOnCoordinates(lat, lng, buildingType, sourceName = '–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ') {
            markerCount++;
            const markerId = `marker_${markerCount}`;
            const buildingName = document.getElementById('building_type').options[document.getElementById('building_type').selectedIndex].text;
            const latFixed = lat.toFixed(4);
            const lngFixed = lng.toFixed(4);

            // 1. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –ø–æ–∏—Å–∫–∞)
            if (sourceName !== '–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ') {
                map.setView([lat, lng], 14); // –ü—Ä–∏–±–ª–∏–∂–∞–µ–º –∫ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —É–ª–∏—Ü–µ
            }
            
            // 2. –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –∏ –æ—Ç—á–µ—Ç–∞-–∑–∞–≥–ª—É—à–∫–∏
            let currentMarker = L.marker([lat, lng]).addTo(markers);
            currentMarker.bindPopup(`**–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName}**<br>–ò—Å—Ç–æ—á–Ω–∏–∫: ${sourceName}<br>‚è≥ –ò–¥–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑...`).openPopup();
            
            const resultsDiv = document.getElementById('results');
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            const newReportHtml = `<div id="${markerId}" style="margin-bottom: 20px; border: 2px solid #004d40; padding: 15px; border-radius: 8px;">
                <h4>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName} (${latFixed}, ${lngFixed})</h4>
                <p><strong>–û—Ü–µ–Ω–∫–∞:</strong> <span class="score-box" style="background-color: gray;">...</span></p>
            </div>`;
            resultsDiv.innerHTML = newReportHtml + resultsDiv.innerHTML; // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            
            const currentReportDiv = document.getElementById(markerId);
            
            try {
                // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
                const rawData = await fetchNASAData(lat, lng);
                const { finalScore, report, finalVerdict } = getAnalysisScore(rawData, buildingType); 
                
                const finalColor = getColorForScore(finalScore);

                // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
                currentMarker.setPopupContent(`
                    <h3>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName}</h3>
                    <b>–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê: <span style="color:${finalColor};">${finalScore}/100</span></b>
                    <hr style="margin: 5px 0;">
                    <b>–í–ï–†–î–ò–ö–¢: ${finalVerdict.text}</b>
                `).openPopup();

                // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
                currentReportDiv.querySelector('.score-box').style.backgroundColor = finalColor;
                currentReportDiv.querySelector('.score-box').innerText = `${finalScore}/100`;
                
                // –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç HTML
                currentReportDiv.innerHTML = `
                    <h4>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName} (${latFixed}, ${lngFixed})</h4>
                    
                    <div class="verdict" style="background-color: ${finalVerdict.color};">
                        ${finalVerdict.text} <br>
                        <span style="font-size: 0.8em; font-weight: normal;">${finalVerdict.sub}</span>
                    </div>

                    <p style="margin: 10px 0;"><strong>–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê:</strong> <span class="score-box" style="background-color: ${finalColor};">${finalScore}/100</span></p>
                    
                    <div class="report-section">
                        <h4>üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –†–∏—Å–∫–∏ (–í–µ—Å 35%): ${report.safety.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–í—ã—Å–æ—Ç–∞ –Ω–∞–¥ —É—Ä–æ–≤–Ω–µ–º –º–æ—Ä—è:** ${rawData.altitude} –º</li>
                            <li>**–°–µ–π—Å–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫:** ${rawData.seismicRisk}</li>
                            <li>**–†–µ–ª—å–µ—Ñ (–°–∫–ª–æ–Ω):** ${rawData.maxSlope}¬∞ (–ü–ª–æ—Å–∫–æ—Å—Ç–Ω–æ—Å—Ç—å ${rawData.flatnessPercentage}%)</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.safety.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section" style="background-color: #f1f8e9;">
                        <h4>üå± –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è (–í–µ—Å 25%): ${report.sustainability.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏—è (–∏–º–∏—Ç–∞—Ü–∏—è):** ${rawData.populationDensity} —á–µ–ª/–∫–º¬≤</li>
                            <li>**–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã:** ${rawData.envStress}</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.sustainability.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section" style="background-color: #e0f2f1;">
                        <h4>üè• –ó–¥–æ—Ä–æ–≤—å–µ –∏ –≠–∫–æ–ª–æ–≥–∏—è (–í–µ—Å 20%): ${report.healthClimate.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**LST (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏):** ${rawData.landTemp}¬∞C</li>
                            <li>**–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å –±–æ–ª–µ–∑–Ω–µ–π:** ${rawData.diseasePrevalence}%</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.healthClimate.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section">
                        <h4>üí∞ –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å –∏ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–í–µ—Å 20%): ${report.efficiency.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–î–æ—Å—Ç—É–ø –∫ –¥–æ—Ä–æ–≥–µ:** ${rawData.roadProximity}</li>
                            <li>**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–µ—Ç—Ä–∞ (–ö–ª–∏–º–∞—Ç –≤–µ—Ç—Ä–∞):** ${rawData.windSpeed} –º/—Å</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.efficiency.factors.join('<br>')}</li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                currentReportDiv.querySelector('.score-box').innerText = '–û—à–∏–±–∫–∞!';
                currentReportDiv.querySelector('.score-box').style.backgroundColor = '#dc3545';
                console.error("–û—à–∏–±–∫–∞ API:", error);
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ —É–ª–∏—Ü–∞–º ---
        function handleStreetSearch() {
            const searchInput = document.getElementById('street_search').value.toLowerCase().trim();
            const feedbackDiv = document.getElementById('search_feedback');
            feedbackDiv.innerText = '';
            
            if (!searchInput) {
                feedbackDiv.innerText = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã –∏–ª–∏ –≥–æ—Ä–æ–¥–∞.";
                return;
            }
            
            const foundLocation = simulateStreetSearch(searchInput);
            
            if (foundLocation) {
                feedbackDiv.innerText = `–ù–∞–π–¥–µ–Ω–æ: ${foundLocation.name}. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑...`;
                const buildingType = document.getElementById('building_type').value;
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
                startAnalysisOnCoordinates(foundLocation.lat, foundLocation.lng, buildingType, foundLocation.name);
            } else {
                feedbackDiv.innerText = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω—É—é —É–ª–∏—Ü—É/–≥–æ—Ä–æ–¥ –≤ –±–∞–∑–µ –ë–∏—à–∫–µ–∫–∞/–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞.";
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ ---
        map.on('click', async function(e) {
            if (!placementMode) return;
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const buildingType = document.getElementById('building_type').value;
            
            startAnalysisOnCoordinates(lat, lng, buildingType);
        });

        function activatePlacementMode() {
            placementMode = true;
            console.log("–†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É.");
            L.popup()
                .setLatLng(map.getCenter())
                .setContent("‚úÖ –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç.")
                .openOn(map);
        }
        
        function clearAllMarkers() {
            markers.clearLayers();
            document.getElementById('results').innerHTML = '';
            markerCount = 0;
            placementMode = false;
            console.log("–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω.");
            L.popup()
                .setLatLng(map.getCenter())
                .setContent("‚ùå –ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.")
                .openOn(map);
        }
    </script>
</body>
</html>
