<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä SmartBuilding</title>
    
    <!-- 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* 2. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ CSS */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #f0ffef; }
        header { background-color: #004d40; color: white; padding: 15px 20px; text-align: center; border-bottom: 5px solid #00796b; }
        #map { height: 65vh; width: 100%; border-bottom: 3px solid #004d40; }
        #controls { padding: 20px; background: #ffffff; box-shadow: 0 -2px 10px rgba(0,0,0,0.15); border-radius: 8px 8px 0 0; }
        h2 { color: #00796b; border-bottom: 2px solid #e0f2f1; padding-bottom: 5px; margin-top: 0; }
        .control-group { margin-bottom: 15px; display: flex; align-items: center; }
        button { 
            background-color: #388e3c; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            font-size: 16px; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: background-color 0.3s;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #2e7d32; }
        #clear-button { background-color: #d32f2f; }
        #clear-button:hover { background-color: #c62828; }
        
        #results { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; }
        .score-box { 
            font-size: 2em; 
            font-weight: bold; 
            display: inline-block; 
            padding: 8px 12px; 
            border-radius: 5px; 
            color: white;
            min-width: 80px;
            text-align: center;
        }
        .report-section { border: 1px solid #e0f2f1; padding: 15px; margin-top: 10px; border-radius: 6px; }
        .report-section h4 { margin: 0 0 10px 0; color: #00796b; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; }

        .verdict {
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            border-radius: 8px;
            margin-top: 20px;
            color: white;
        }
    </style>
</head>
<body>

    <header>
        <h1>SmartBuilding (–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω) üá∞üá¨</h1>
        <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –≥–µ–æ–∞–Ω–∞–ª–∏–∑: —Ä–∏—Å–∫–∏, —ç–∫–æ–ª–æ–≥–∏—è, –∑–¥–æ—Ä–æ–≤—å–µ –∏ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è.</p>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <div id="map"></div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="controls">
        <h2>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
        
        <div class="control-group">
            <label for="building_type" style="margin-right: 15px;">–¢–∏–ø –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:</label>
            <select id="building_type" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="residential">–ñ–∏–ª–æ–π –¥–æ–º / –®–∫–æ–ª–∞ (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –±–æ–ª–µ–∑–Ω—è–º/—Å—Ä–µ–¥–µ)</option>
                <option value="industrial">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç / –ó–∞–≤–æ–¥ (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –ª–æ–≥–∏—Å—Ç–∏–∫–µ)</option>
                <option value="wind_farm">–í–µ—Ç—Ä—è–Ω–∞—è —Ñ–µ—Ä–º–∞ / –≠–Ω–µ—Ä–≥–æ–æ–±—ä–µ–∫—Ç (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –≤–µ—Ç—Ä—É/—Ä–µ–ª—å–µ—Ñ—É)</option>
            </select>
        </div>
        
        <button onclick="activatePlacementMode()">
            üìå –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∏ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –û–±—ä–µ–∫—Ç
        </button>
        <button id="clear-button" onclick="clearAllMarkers()">
            ‚ùå –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
        </button>

        <div id="results">
            <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- 4. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ -->
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        var map = L.map('map').setView([41.2044, 74.7661], 7); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        var markers = L.layerGroup().addTo(map); 
        var placementMode = false;
        var markerCount = 0;

        // --- –§—É–Ω–∫—Ü–∏—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –î–∞–Ω–Ω—ã–º ---
        async function fetchNASAData(lat, lng) {
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            const isHighElevation = lat > 40.5 && lng > 76.5 && Math.random() < 0.8; 
            const isNearCity = (Math.abs(lat - 42.87) < 0.2 && Math.abs(lng - 74.59) < 0.2); // –ë–∏—à–∫–µ–∫
            const isSouthWest = lat < 41 && lng < 74; // –ò–º–∏—Ç–∞—Ü–∏—è –Æ–≥–æ-–ó–∞–ø–∞–¥–∞

            // 1. –ì–µ–æ–ª–æ–≥–∏—è/–ü–æ—á–≤–∞/–†–µ–ª—å–µ—Ñ
            const surfaceTypes = ['–°–∫–∞–ª—å–Ω—ã–π –≥—Ä—É–Ω—Ç', '–û—Å—ã–ø—å/–û–ø–æ–ª–∑–Ω–µ–æ–ø–∞—Å–Ω—ã–π —Å–∫–ª–æ–Ω', '–°–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–≥–æ–¥—å—è', '–ü–ª–æ—Ç–Ω–∞—è –∑–∞—Å—Ç—Ä–æ–π–∫–∞/–¶–µ–º–µ–Ω—Ç', '–ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞/–ü–∞—Ä–∫'];
            const landCoverType = isNearCity ? (Math.random() < 0.6 ? surfaceTypes[3] : surfaceTypes[4]) : surfaceTypes[Math.floor(Math.random() * 3)];
            
            const maxSlope = isHighElevation ? (25 + Math.random() * 35).toFixed(0) : (1 + Math.random() * 8).toFixed(0); 
            const flatnessPercentage = (100 - maxSlope * 2.5).toFixed(0); // –ü–ª–æ—Å–∫–æ—Å—Ç—å 

            // 2. –†–∏—Å–∫–∏ –°—Ç–∏—Ö–∏–π–Ω—ã—Ö –ë–µ–¥—Å—Ç–≤–∏–π (–ù–û–í–û–ï)
            let naturalDisasterRisk = '–ù–∏–∑–∫–∏–π';
            if (isHighElevation && maxSlope > 30) naturalDisasterRisk = '–í—ã—Å–æ–∫–∏–π (–û–ø–æ–ª–∑–Ω–∏/–°–µ–ª–∏)';
            else if (isSouthWest && Math.random() < 0.4) naturalDisasterRisk = '–°—Ä–µ–¥–Ω–∏–π (–ù–∞–≤–æ–¥–Ω–µ–Ω–∏—è/–ü–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è)';
            
            // 3. –ó–¥–æ—Ä–æ–≤—å–µ/–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è (–ù–û–í–û–ï)
            const populationDensity = isNearCity ? (600 + Math.random() * 1800).toFixed(0) : (5 + Math.random() * 70).toFixed(0); 
            const envStress = isNearCity || Math.random() < 0.1 ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è (–∏—Å—Ç–æ—â–µ–Ω–∏–µ –≤–æ–¥–Ω—ã—Ö/–∑–µ–º–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤)' : '–ù–∏–∑–∫–∞—è (—É—Å—Ç–æ–π—á–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)';
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–∑–Ω–µ–π: –≤—ã—à–µ –≤ –ø–ª–æ—Ç–Ω—ã—Ö/—é–∂–Ω—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö
            const diseasePrevalence = (isNearCity ? 3.5 + Math.random() * 2 : 1 + Math.random() * 2).toFixed(1); // % –±–æ–ª—å–Ω—ã—Ö –Ω–∞ 1000

            // 4. –ö–ª–∏–º–∞—Ç/–õ–æ–≥–∏—Å—Ç–∏–∫–∞
            const windSpeed = (isHighElevation ? 8 + Math.random() * 12 : 3 + Math.random() * 7).toFixed(1);
            const roadProximity = isNearCity ? '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)' : (Math.random() < 0.5 ? '–•–æ—Ä–æ—à–æ (3-5 –∫–º)' : '–ü–ª–æ—Ö–æ (–±–æ–ª–µ–µ 10 –∫–º)');
            const seismicRisk = isHighElevation ? (Math.random() < 0.4 ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π' : '–í—ã—Å–æ–∫–∏–π') : '–°—Ä–µ–¥–Ω–∏–π';


            return {
                landCoverType: landCoverType,
                maxSlope: parseFloat(maxSlope),
                flatnessPercentage: parseFloat(flatnessPercentage),
                naturalDisasterRisk: naturalDisasterRisk,
                diseasePrevalence: parseFloat(diseasePrevalence),
                populationDensity: parseFloat(populationDensity),
                envStress: envStress,
                windSpeed: parseFloat(windSpeed),
                roadProximity: roadProximity,
                seismicRisk: seismicRisk,
                lat: lat,
                lng: lng
            };
        }

        // --- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø) ---
        function getAnalysisScore(data, buildingType) {
            let safetyPenalty = 0;
            let sustainabilityPenalty = 0; 
            let healthPenalty = 0;
            let efficiencyBonus = 0;
            
            let report = {
                safety: { score: 100, factors: [] },
                sustainability: { score: 100, factors: [] },
                healthClimate: { score: 100, factors: [] }, // –ù–û–í–´–ô –†–ê–ó–î–ï–õ
                efficiency: { score: 100, factors: [] },
            };
            let hardStopWarning = false; // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤

            // --- 1. –ê–ù–ê–õ–ò–ó –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (SAFETY & DISASTER RISK) ---
            
            // –°–µ–π—Å–º–∏–∫–∞
            if (data.seismicRisk === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í—ã—Å–æ–∫–∏–π') {
                safetyPenalty += 40;
                report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫. (-40)');
                if (buildingType === 'residential') hardStopWarning = true;
            } else if (data.seismicRisk === '–í—ã—Å–æ–∫–∏–π') {
                safetyPenalty += 20;
                report.safety.factors.push('–°–µ–π—Å–º–∏–∫–∞: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫. (-20)');
            }

            // –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–µ–¥—Å—Ç–≤–∏—è –∏ –†–µ–ª—å–µ—Ñ
            if (data.naturalDisasterRisk.includes('–û–ø–æ–ª–∑–Ω–∏') || data.landCoverType.includes('–û–ø–æ–ª–∑–Ω–µ–æ–ø–∞—Å–Ω—ã–π')) {
                safetyPenalty += 50;
                report.safety.factors.push(`**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö:** –û–ø–æ–ª–∑–Ω–∏/–°–µ–ª–∏. (${data.maxSlope}¬∞). (-50)`);
                hardStopWarning = true;
            } else if (data.naturalDisasterRisk.includes('–ù–∞–≤–æ–¥–Ω–µ–Ω–∏—è') && data.flatnessPercentage > 80) {
                safetyPenalty += 30;
                report.safety.factors.push('–†–∏—Å–∫ –ù–∞–≤–æ–¥–Ω–µ–Ω–∏–π: –í—ã—Å–æ–∫–∏–π (–ø–ª–æ—Å–∫–∞—è –ø–æ–π–º–∞ —Ä–µ–∫–∏). (-30)');
            } else if (data.landCoverType.includes('–í–æ–¥–æ–æ—Ö—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞')) {
                safetyPenalty += 40;
                report.safety.factors.push('–ó–∞–ø—Ä–µ—Ç: –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–æ–¥–æ–æ—Ö—Ä–∞–Ω–Ω–æ–π/–∑–∞—â–∏—Ç–Ω–æ–π –∑–æ–Ω–µ. (-40)');
                hardStopWarning = true;
            }
            
            // --- 2. –ê–ù–ê–õ–ò–ó –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò (SUSTAINABILITY & DEMOGRAPHY) ---
            
            // –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å vs –°—Ä–µ–¥–∞
            if (data.populationDensity > 800 && data.envStress.includes('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è')) {
                sustainabilityPenalty += 40;
                report.sustainability.factors.push(`–î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (${data.populationDensity} —á–µ–ª/–∫–º¬≤) + –ò—Å—Ç–æ—â–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤. **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å—Ä–µ–¥—É –Ω–µ–Ω–æ—Ä–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–∞—è.** (-40)`);
            } else if (data.populationDensity > 300 && data.envStress.includes('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è')) {
                sustainabilityPenalty += 20;
                report.sustainability.factors.push(`–°—Ä–µ–¥–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã (–≤–æ–¥—É/–∑–µ–º–ª—é). (-20)`);
            } else {
                report.sustainability.factors.push('–£—Å—Ç–æ–π—á–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –Ω–∞—Å–µ–ª–µ–Ω–∏—è –∏ —Ä–µ—Å—É—Ä—Å–æ–≤. (+0)');
            }

            // --- 3. –ê–ù–ê–õ–ò–ó –ó–î–û–†–û–í–¨–Ø –ò –≠–ö–û–õ–û–ì–ò–ò (HEALTH & MICROCLIMATE) ---
            
            // –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å –±–æ–ª–µ–∑–Ω–µ–π
            if (data.diseasePrevalence > 4.5) {
                healthPenalty += 40;
                report.healthClimate.factors.push(`–ë–æ–ª–µ–∑–Ω–∏: –í—ã—Å–æ–∫–∞—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å (${data.diseasePrevalence}%). **–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –¥–ª—è –∂–∏–ª–æ–≥–æ/—à–∫–æ–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞.** (-40)`);
                if (buildingType === 'residential') hardStopWarning = true;
            } else if (data.diseasePrevalence > 3.0) {
                healthPenalty += 20;
                report.healthClimate.factors.push(`–ë–æ–ª–µ–∑–Ω–∏: –°—Ä–µ–¥–Ω—è—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å. (-20)`);
            }

            // –ó–µ–ª–µ–Ω—ã–µ –∑–æ–Ω—ã / –£—Ä–±–∞–Ω–∏–∑–∞—Ü–∏—è
            if (data.landCoverType.includes('–ü–ª–æ—Ç–Ω–∞—è –∑–∞—Å—Ç—Ä–æ–π–∫–∞/–¶–µ–º–µ–Ω—Ç')) {
                healthPenalty += 15;
                report.healthClimate.factors.push('–ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç: **–≠—Ñ—Ñ–µ–∫—Ç "—Ç–µ–ø–ª–æ–≤–æ–≥–æ –æ—Å—Ç—Ä–æ–≤–∞"** (–≤—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –Ω–∏–∑–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å). (-15)');
                if (buildingType === 'residential') healthPenalty += 10; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ –¥–ª—è –∂–∏–ª—å—è
            } else if (data.landCoverType.includes('–ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞/–ü–∞—Ä–∫')) {
                healthPenalty -= 10;
                report.healthClimate.factors.push('–ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç: –ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞ (–Ω–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å). (+10)');
            }


            // --- 4. –ê–ù–ê–õ–ò–ó –í–´–ì–û–î–ù–û–°–¢–ò/–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò (EFFICIENCY) ---

            // –õ–æ–≥–∏—Å—Ç–∏–∫–∞/–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            if (data.roadProximity === '–ü–ª–æ—Ö–æ (–±–æ–ª–µ–µ 10 –∫–º)') {
                efficiencyBonus -= 25;
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –£–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç –¥–æ—Ä–æ–≥ (>10 –∫–º), –≤—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π. (-25)');
            } else if (data.roadProximity === '–û—Ç–ª–∏—á–Ω–æ (–º–µ–Ω–µ–µ 1 –∫–º)') {
                efficiencyBonus += 15;
                report.efficiency.factors.push('–õ–æ–≥–∏—Å—Ç–∏–∫–∞: –û—Ç–ª–∏—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å. (+15)');
            }
            
            // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¢–∏–ø—É –û–±—ä–µ–∫—Ç–∞
            if (buildingType === 'wind_farm') {
                if (data.windSpeed > 10) {
                    efficiencyBonus += 30;
                    report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –í—ã—Å–æ–∫–∏–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª! (+30)');
                } else if (data.windSpeed < 5) {
                    efficiencyBonus -= 30;
                    report.efficiency.factors.push('–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞: –ù–∏–∑–∫–∏–π –≤–µ—Ç—Ä–æ–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. (-30)');
                }
            } else if (buildingType === 'industrial') {
                if (data.landCoverType.includes('–°–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–≥–æ–¥—å—è')) {
                    efficiencyBonus -= 15;
                    report.efficiency.factors.push('–ó–µ–º–ª–µ–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ü–æ—Ç–µ—Ä—è —Ü–µ–Ω–Ω–æ–π —Å–µ–ª—å—Ö–æ–∑–∑–µ–º–ª–∏. (-15)');
                }
            }


            // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤—ã—Ö –±–∞–ª–ª–æ–≤
            report.safety.score = Math.max(0, 100 - safetyPenalty).toFixed(0);
            report.sustainability.score = Math.max(0, 100 - sustainabilityPenalty).toFixed(0);
            report.healthClimate.score = Math.max(0, 100 - healthPenalty).toFixed(0);
            report.efficiency.score = Math.max(0, 100 + efficiencyBonus).toFixed(0);
            
            // –ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç: –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å > –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å/–ó–¥–æ—Ä–æ–≤—å–µ > –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å)
            const finalScore = (
                0.40 * report.safety.score + 
                0.30 * report.sustainability.score +
                0.20 * report.healthClimate.score +
                0.10 * report.efficiency.score
            ).toFixed(0);


            // --- –§–ò–ù–ê–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢ ---
            let finalVerdict = { text: '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É', color: '#1b5e20', sub: '–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ –∏ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è.' };

            if (hardStopWarning) {
                finalVerdict = { text: '–°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û –ù–ï–í–û–ó–ú–û–ñ–ù–û / –ö–†–ê–ô–ù–ï –û–ü–ê–°–ù–û', color: '#b71c1c', sub: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —Ñ–∞–∫—Ç–æ—Ä—ã (–û–ø–æ–ª–∑–Ω–∏, –í–æ–¥–æ–æ—Ö—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞, –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–π—Å–º–∏–∫–∞ –¥–ª—è –∂–∏–ª—å—è, –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –±–æ–ª–µ–∑–Ω–µ–π –¥–ª—è –∂–∏–ª—å—è).' };
            } else if (finalScore < 50) {
                 finalVerdict = { text: '–ù–ï –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û', color: '#ff6f00', sub: '–†–∏—Å–∫–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞—é—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –≤—ã–≥–æ–¥—É. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞.' };
            } else if (finalScore < 70) {
                finalVerdict = { text: '–£–°–õ–û–í–ù–û –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û (–° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï–ú)', color: '#ffd600', sub: '–ü—Ä–æ–µ–∫—Ç –≤–æ–∑–º–æ–∂–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ä –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é —Ä–∏—Å–∫–æ–≤ (—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å –±–æ–ª–µ–∑–Ω–µ–π, —É–ª—É—á—à–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã).' };
            }


            return { finalScore, report, finalVerdict };
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ ---
        map.on('click', async function(e) {
            if (!placementMode) return;
            markerCount++;
            const markerId = `marker_${markerCount}`;
            const lat = e.latlng.lat.toFixed(4);
            const lng = e.latlng.lng.toFixed(4);
            const buildingType = document.getElementById('building_type').value;
            const buildingName = document.getElementById('building_type').options[document.getElementById('building_type').selectedIndex].text;

            let currentMarker = L.marker([lat, lng]).addTo(markers);
            currentMarker.bindPopup(`**–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName}**<br>‚è≥ –ò–¥–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑...`).openPopup();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div id="${markerId}" style="margin-bottom: 20px; border: 2px solid #004d40; padding: 15px; border-radius: 8px;">
                <h4>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName} (${lat}, ${lng})</h4>
                <p><strong>–û—Ü–µ–Ω–∫–∞:</strong> <span class="score-box" style="background-color: gray;">...</span></p>
            </div>`;
            const currentReportDiv = document.getElementById(markerId);
            
            try {
                const rawData = await fetchNASAData(lat, lng);
                const { finalScore, report, finalVerdict } = getAnalysisScore(rawData, buildingType);
                
                let color;
                if (finalScore >= 75) color = '#2e7d32'; 
                else if (finalScore >= 50) color = '#ffa000';
                else color = '#d32f2f'; 

                currentMarker.setPopupContent(`
                    <h3>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName}</h3>
                    <b>–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê: <span style="color:${color};">${finalScore}/100</span></b>
                    <hr style="margin: 5px 0;">
                    <b>–í–ï–†–î–ò–ö–¢: ${finalVerdict.text}</b>
                `).openPopup();

                currentReportDiv.querySelector('.score-box').style.backgroundColor = color;
                currentReportDiv.querySelector('.score-box').innerText = `${finalScore}/100`;
                
                // –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç —Å —á–µ—Ç—ã—Ä—å–º—è —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ –í–µ—Ä–¥–∏–∫—Ç–æ–º
                currentReportDiv.innerHTML = `
                    <h4>–û–±—ä–µ–∫—Ç #${markerCount}: ${buildingName} (${lat}, ${lng})</h4>
                    
                    <div class="verdict" style="background-color: ${finalVerdict.color};">
                        ${finalVerdict.text} <br>
                        <span style="font-size: 0.8em; font-weight: normal;">${finalVerdict.sub}</span>
                    </div>

                    <p style="margin: 10px 0;"><strong>–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê:</strong> <span class="score-box" style="background-color: ${color};">${finalScore}/100</span></p>
                    
                    <div class="report-section">
                        <h4>üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –†–∏—Å–∫–∏: ${report.safety.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–°–µ–π—Å–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫:** ${rawData.seismicRisk}</li>
                            <li>**–°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–µ–¥—Å—Ç–≤–∏—è:** ${rawData.naturalDisasterRisk}</li>
                            <li>**–†–µ–ª—å–µ—Ñ:** –ü–ª–æ—Å–∫–æ—Å—Ç–Ω–æ—Å—Ç—å ${rawData.flatnessPercentage}% (–°–∫–ª–æ–Ω ${rawData.maxSlope}¬∞)</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.safety.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section" style="background-color: #f1f8e9;">
                        <h4>üå± –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è: ${report.sustainability.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏—è (–∏–º–∏—Ç–∞—Ü–∏—è):** ${rawData.populationDensity} —á–µ–ª/–∫–º¬≤</li>
                            <li>**–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã:** ${rawData.envStress}</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.sustainability.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section" style="background-color: #e0f2f1;">
                        <h4>üè• –ó–¥–æ—Ä–æ–≤—å–µ –∏ –≠–∫–æ–ª–æ–≥–∏—è: ${report.healthClimate.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å –±–æ–ª–µ–∑–Ω–µ–π (–∏–º–∏—Ç–∞—Ü–∏—è):** ${rawData.diseasePrevalence}%</li>
                            <li>**–¢–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è:** ${rawData.landCoverType} (–í–ª–∞–∂–Ω–æ—Å—Ç—å/–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.healthClimate.factors.join('<br>')}</li>
                        </ul>
                    </div>
                    
                    <div class="report-section">
                        <h4>üí∞ –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å –∏ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${report.efficiency.score}/100</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            <li>**–î–æ—Å—Ç—É–ø –∫ –¥–æ—Ä–æ–≥–µ:** ${rawData.roadProximity}</li>
                            <li>**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–µ—Ç—Ä–∞:** ${rawData.windSpeed} –º/—Å</li>
                            <li>**–§–∞–∫—Ç–æ—Ä—ã:** ${report.efficiency.factors.join('<br>')}</li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                currentReportDiv.querySelector('.score-box').innerText = '–û—à–∏–±–∫–∞!';
                currentReportDiv.querySelector('.score-box').style.backgroundColor = '#dc3545';
                console.error("–û—à–∏–±–∫–∞ API:", error);
            }
        });

        function activatePlacementMode() {
            placementMode = true;
            alert("‚úÖ –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç—á–µ—Ç.");
        }
        
        function clearAllMarkers() {
            markers.clearLayers();
            document.getElementById('results').innerHTML = '';
            markerCount = 0;
            placementMode = false;
            alert("–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω.");
        }
    </script>
</body>
</html>
